<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retirement Planning Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        /* CSS Variables for theming */
        :root {
            /* Light mode (default) */
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f0f2f5;
            --text-primary: #1a1a2e;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border-color: #e2e8f0;
            --border-light: #edf2f7;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --card-bg: #ffffff;
            --input-bg: #f7fafc;
            --input-border: #e2e8f0;
            --accent: #3182ce;
            --accent-light: #ebf8ff;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a2e;
            --bg-secondary: rgba(255,255,255,0.05);
            --bg-tertiary: rgba(255,255,255,0.03);
            --text-primary: #e8e8e8;
            --text-secondary: #a0aec0;
            --text-muted: #718096;
            --border-color: rgba(255,255,255,0.1);
            --border-light: rgba(255,255,255,0.05);
            --shadow: 0 2px 8px rgba(0,0,0,0.3);
            --card-bg: rgba(255,255,255,0.05);
            --input-bg: rgba(255,255,255,0.08);
            --input-border: rgba(255,255,255,0.15);
            --accent: #4facfe;
            --accent-light: rgba(79,172,254,0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s, color 0.3s;
        }
        .container { max-width: 1400px; margin: 0 auto; }

        /* Header with theme toggle */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .header-title {
            flex: 1;
            text-align: center;
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: var(--accent);
        }
        .subtitle { color: var(--text-muted); font-size: 0.9rem; }

        /* Theme toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .theme-toggle:hover { background: var(--accent-light); }

        /* Tooltip system */
        .info-tip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: #3182ce;
            color: white;
            border-radius: 50%;
            font-size: 11px;
            font-weight: 700;
            cursor: help;
            margin-left: 6px;
            position: relative;
        }
        .info-tip:hover .tooltip,
        .info-tip:focus .tooltip {
            display: block;
        }
        .tooltip,
        .info-tip .tooltip,
        span.tooltip {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            left: auto;
            right: 0;
            width: 280px;
            max-width: 90vw;
            padding: 14px;
            background: #1e293b !important;
            color: #f8fafc !important;
            border-radius: 8px;
            font-size: 0.85rem !important;
            font-weight: 400 !important;
            line-height: 1.6;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            text-align: left;
            word-wrap: break-word;
        }
        .tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            right: 12px;
            border: 8px solid transparent;
            border-bottom-color: #1e293b;
        }

        /* Collapsible sections */
        .collapsible-section {
            background: var(--card-bg);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            overflow: visible;
        }
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-light);
            transition: background 0.2s;
        }
        .collapsible-header:hover { background: var(--accent-light); }
        .collapsible-header h3 {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .collapse-icon {
            transition: transform 0.3s;
            color: var(--text-muted);
        }
        .collapsible-section.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
        .collapsible-content {
            padding: 20px;
            transition: max-height 0.3s ease-out;
        }
        .collapsible-section.collapsed .collapsible-content {
            display: none;
        }

        /* Retirement Status Banner */
        .status-banner {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .status-banner.green {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.15), rgba(34, 197, 94, 0.1));
            border: 2px solid #4ade80;
        }
        .status-banner.yellow {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(245, 158, 11, 0.1));
            border: 2px solid #fbbf24;
        }
        .status-banner.red {
            background: linear-gradient(135deg, rgba(248, 113, 113, 0.15), rgba(239, 68, 68, 0.1));
            border: 2px solid #f87171;
        }
        .status-icon {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .status-banner.green .status-icon { background: rgba(74, 222, 128, 0.2); }
        .status-banner.yellow .status-icon { background: rgba(251, 191, 36, 0.2); }
        .status-banner.red .status-icon { background: rgba(248, 113, 113, 0.2); }
        .status-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .status-banner.green .status-title { color: #4ade80; }
        .status-banner.yellow .status-title { color: #fbbf24; }
        .status-banner.red .status-title { color: #f87171; }
        .status-detail {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 18px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }
        .card-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .card-value { font-size: 1.5rem; font-weight: 700; margin-top: 5px; }
        .card-sub { font-size: 0.75rem; color: var(--text-muted); margin-top: 5px; }
        .green { color: #4ade80; }
        .blue { color: #60a5fa; }
        .yellow { color: #fbbf24; }
        .red { color: #f87171; }
        .purple { color: #a78bfa; }
        .orange { color: #fb923c; }

        /* Controls Section */
        .controls-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }
        .controls-title { font-size: 1rem; font-weight: 600; margin-bottom: 20px; color: var(--accent); }
        .controls-subtitle { font-size: 0.85rem; color: var(--text-muted); margin: 20px 0 15px 0; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .control-group { }
        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.8rem;
        }
        .control-label span:first-child { color: var(--text-secondary); }
        .control-label span:last-child { font-weight: 600; }
        .control-label .mike-color { color: #60a5fa; }
        .control-label .travis-color { color: #4ade80; }
        .control-label .default-color { color: var(--accent); }

        /* Number inputs (replacing sliders) */
        .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .input-group input[type="number"] {
            width: 80px;
            padding: 8px 10px;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 500;
        }
        .input-group input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
        }
        .input-group .unit {
            color: var(--text-muted);
            font-size: 0.75rem;
        }
        input[type="number"] {
            width: 80px;
            padding: 6px 8px;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
        }
        .number-input-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .currency-prefix {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .input-suffix {
            color: var(--text-muted);
            font-size: 0.75rem;
        }
        .contrib-input {
            width: 100px;
            padding: 8px 10px;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
        }
        .contrib-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .contrib-input.mike-border:focus { border-color: #60a5fa; }
        .contrib-input.travis-border:focus { border-color: #4ade80; }
        .contrib-input::placeholder {
            color: var(--text-muted);
            font-weight: 400;
        }
        .contrib-input[type="number"]::-webkit-inner-spin-button { opacity: 0.5; }

        /* Keep range slider styles for now but hidden */
        input[type="range"] { display: none; }

        /* Contribution Changes Table */
        .changes-table-container {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .changes-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .changes-table th {
            text-align: left;
            padding: 8px 10px;
            color: var(--text-muted);
            font-weight: 500;
            font-size: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        .changes-table td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-light);
        }
        .changes-table tr:last-child td { border-bottom: none; }
        .changes-table .person-mike { color: #60a5fa; }
        .changes-table .person-travis { color: #4ade80; }
        .changes-table input {
            width: 80px;
            padding: 6px 8px;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        .changes-table input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .changes-table select {
            padding: 6px 8px;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        .changes-table select:focus {
            outline: none;
            border-color: var(--accent);
        }
        .btn-remove {
            background: rgba(248, 113, 113, 0.2);
            border: none;
            color: #f87171;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }
        .btn-remove:hover { background: rgba(248, 113, 113, 0.3); }
        .btn-add {
            background: var(--accent-light);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-add:hover { background: var(--accent); color: white; }
        .btn-add:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .changes-count {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: 10px;
        }
        .empty-changes {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Rental Properties Styles */
        .rental-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .rental-card {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 18px;
            border: 1px solid var(--border-color);
        }
        .rental-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .rental-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: #fb923c;
        }
        .rental-card-address {
            font-size: 0.7rem;
            color: #666;
        }
        .rental-status {
            font-size: 0.65rem;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        .rental-status.active {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }
        .rental-status.sold {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
        }
        .rental-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.8rem;
        }
        .rental-stat {
            display: flex;
            flex-direction: column;
        }
        .rental-stat-label {
            color: var(--text-muted);
            font-size: 0.65rem;
            text-transform: uppercase;
        }
        .rental-stat-value {
            font-weight: 600;
            margin-top: 2px;
        }
        .rental-net-income {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .rental-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
        }
        .rental-input-row label {
            font-size: 0.75rem;
            color: var(--text-muted);
            min-width: 100px;
        }
        .rental-input-row input[type="number"] {
            width: 80px;
        }
        .rental-input-row input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #fb923c;
        }
        .sell-options {
            margin-top: 10px;
            padding: 10px;
            background: rgba(248, 113, 113, 0.1);
            border-radius: 6px;
            font-size: 0.75rem;
        }
        .sell-options.hidden { display: none; }
        .bar-rental { background: #fb923c; }

        /* Results Section */
        .results-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 900px) {
            .results-section { grid-template-columns: 1fr; }
        }
        .result-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }
        .result-title { font-size: 1rem; font-weight: 600; margin-bottom: 15px; }

        /* Scenarios Table */
        .scenarios-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        .scenarios-table th, .scenarios-table td {
            padding: 10px 8px;
            text-align: right;
            border-bottom: 1px solid var(--border-light);
        }
        .scenarios-table th { color: var(--text-muted); font-weight: 500; font-size: 0.7rem; }
        .scenarios-table th:first-child, .scenarios-table td:first-child { text-align: left; }
        .scenarios-table tr:hover { background: var(--bg-tertiary); }
        .highlight-row { background: var(--accent-light) !important; }
        .success-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
        }
        .success-badge.yes { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
        .success-badge.maybe { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .success-badge.no { background: rgba(248, 113, 113, 0.2); color: #f87171; }
        .age-display { font-size: 0.65rem; color: var(--text-muted); }

        /* Chart Container */
        .chart-container { height: 320px; position: relative; }

        /* Person Cards */
        .person-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 900px) {
            .person-section { grid-template-columns: 1fr; }
        }
        .person-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }
        .person-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; }
        .person-name.mike { color: #60a5fa; }
        .person-name.travis { color: #4ade80; }
        .account-list { font-size: 0.85rem; }
        .account-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
        }
        .account-item:last-child { border-bottom: none; }
        .account-name { color: var(--text-secondary); }
        .account-value { font-weight: 500; }

        /* Income Breakdown Section */
        .income-breakdown {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }
        .income-bar {
            display: flex;
            height: 30px;
            border-radius: 6px;
            overflow: hidden;
            margin: 15px 0;
        }
        .income-bar div {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: #fff;
        }
        .bar-salary { background: #22c55e; }
        .bar-pension { background: #fbbf24; }
        .bar-portfolio { background: #4facfe; }
        .bar-ss { background: #a78bfa; }
        .income-legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 0.75rem;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

        /* Phase Tabs */
        .phase-tabs {
            display: flex;
            gap: 4px;
            margin: 10px 0 15px 0;
            flex-wrap: wrap;
        }
        .phase-tab {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.72rem;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            transition: all 0.2s;
            white-space: nowrap;
        }
        .phase-tab:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        .phase-tab.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        /* Expense Bar */
        .expense-bar {
            display: flex;
            height: 30px;
            border-radius: 6px;
            overflow: hidden;
            margin: 8px 0;
        }
        .expense-bar div {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: #fff;
        }
        .bar-mortgage { background: #ef4444; }
        .bar-taxins { background: #f97316; }
        .bar-healthcare { background: #ec4899; }
        .bar-living { background: #8b5cf6; }
        .bar-onetime { background: #6366f1; }

        /* Bar Row Labels */
        .bar-row-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-top: 12px;
        }
        .bar-row-label span {
            color: var(--text-primary);
        }

        /* Expense Legend */
        .expense-legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 0.75rem;
        }

        /* Bar Wrapper (proportional scaling) */
        #incomeBarWrapper, #expenseBarWrapper {
            transition: width 0.3s ease;
        }

        /* Surplus/Deficit Indicator */
        .surplus-indicator {
            margin-top: 12px;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
        }
        .surplus-indicator.surplus {
            background: rgba(74, 222, 128, 0.1);
            color: #4ade80;
            border: 1px solid rgba(74, 222, 128, 0.3);
        }
        .surplus-indicator.deficit {
            background: rgba(248, 113, 113, 0.1);
            color: #f87171;
            border: 1px solid rgba(248, 113, 113, 0.3);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        /* Chart tooltip custom */
        .chart-tooltip {
            background: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: 8px !important;
            padding: 10px !important;
        }

        /* Helper text */
        .helper-text {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Note boxes */
        .note-box {
            font-size: 0.7rem;
            color: var(--text-secondary);
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }
        .note-box.info { background: var(--accent-light); }
        .note-box.warning { background: rgba(251, 191, 36, 0.1); }
        .note-box.danger { background: rgba(248, 113, 113, 0.1); }

        /* Card layout classes */
        .cards-primary { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .cards-secondary { margin-top: -10px; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
        .card-compact { padding: 12px 15px; }

        /* ========== MOBILE RESPONSIVE ========== */
        @media (max-width: 600px) {
            .container { padding: 10px; }
            h1 { font-size: 1.2rem !important; }
            h3 { font-size: 0.9rem; }

            /* Summary cards: 2 columns on phone */
            .cards-primary { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .cards-secondary { grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: -5px; }
            .card { padding: 12px; }
            .card-value { font-size: 1.15rem; }
            .card-compact .card-value { font-size: 1rem !important; }
            .card-label { font-size: 0.6rem; }
            .card-sub { font-size: 0.6rem; }

            /* Status banner */
            .status-banner { padding: 12px 15px; }
            .status-title { font-size: 0.9rem; }
            .status-detail { font-size: 0.7rem; }
            .status-icon { font-size: 1.2rem; width: 35px; height: 35px; }

            /* Chart taller on mobile for readability */
            .chart-container { height: 250px; }

            /* Controls: stack inputs vertically */
            .controls-grid { grid-template-columns: 1fr !important; gap: 12px; }

            /* Bigger touch targets for inputs */
            input[type="number"], select {
                font-size: 16px !important; /* Prevents iOS zoom on focus */
                min-height: 40px;
                padding: 8px 10px;
            }
            input[type="checkbox"] {
                width: 20px;
                height: 20px;
            }
            .input-group { gap: 6px; }

            /* Person cards: single column */
            .person-section { grid-template-columns: 1fr; gap: 12px; }
            .person-card { padding: 15px; }
            .person-name { font-size: 0.95rem; }
            .account-list { font-size: 0.8rem; }
            .account-item { padding: 6px 0; }

            /* Scenario table: horizontal scroll */
            .results-section { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .scenarios-table { font-size: 0.65rem; min-width: 500px; }
            .scenarios-table th, .scenarios-table td { padding: 6px 4px; }

            /* Rental cards: single column */
            .rental-cards { grid-template-columns: 1fr !important; }
            .rental-card { padding: 15px; }

            /* Income breakdown: smaller text */
            .income-legend { font-size: 0.7rem; }
            .expense-legend { font-size: 0.7rem; }
            .phase-tabs { gap: 3px; }
            .phase-tab { padding: 5px 8px; font-size: 0.65rem; }
            .surplus-indicator { font-size: 0.75rem; padding: 6px 10px; }

            /* Collapsible sections */
            .collapsible-header { padding: 12px 15px; }
            .collapsible-content { padding: 12px; }

            /* Section labels */
            div[style*="letter-spacing: 2px"] { font-size: 0.7rem !important; margin: 18px 0 8px 0 !important; }

            /* Result card */
            .result-card { padding: 15px; }
            .result-title { font-size: 0.85rem; }

            /* Footer */
            .footer { font-size: 0.55rem; padding: 15px; }
        }

        /* Tablet tweaks */
        @media (max-width: 900px) and (min-width: 601px) {
            .cards-primary { grid-template-columns: repeat(2, 1fr); }
            .cards-secondary { grid-template-columns: repeat(4, 1fr); }
            .controls-grid { grid-template-columns: repeat(2, 1fr) !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="width: 100px;"></div>
            <div class="header-title">
                <h1>Retirement Planning Dashboard</h1>
                <p class="subtitle">Mike & Travis | Based on 2025 Financial Data</p>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span id="themeIcon">üåô</span>
                <span id="themeLabel">Dark</span>
            </button>
        </div>

        <!-- Retirement Status Indicator -->
        <div class="status-banner" id="statusBanner">
            <div class="status-icon" id="statusIcon">‚úì</div>
            <div class="status-content">
                <div class="status-title" id="statusTitle">On Track for Retirement</div>
                <div class="status-detail" id="statusDetail">Income exceeds expenses by $12,440/year when both retired</div>
            </div>
        </div>

        <!-- Key Numbers: The 4 things that matter most -->
        <div class="cards-grid cards-primary">
            <div class="card">
                <div class="card-label">Household Net Worth</div>
                <div class="card-value" style="color:#c084fc;" id="netWorthCard">$1,185,868</div>
                <div class="card-sub">Everything you own minus owe</div>
            </div>
            <div class="card">
                <div class="card-label">Invested for Growth</div>
                <div class="card-value blue" id="totalInvestableCard">$482,783</div>
                <div class="card-sub">Retirement + brokerage accounts</div>
            </div>
            <div class="card">
                <div class="card-label">Projected Retirement Income</div>
                <div class="card-value purple" id="totalIncomePreview">$181,756/yr</div>
                <div class="card-sub">Pension + Portfolio + SS + Rental</div>
            </div>
            <div class="card">
                <div class="card-label">vs Annual Expenses</div>
                <div class="card-value green" id="gapValue">+$12,440</div>
                <div class="card-sub" id="gapSubtext">Surplus at retirement</div>
            </div>
        </div>

        <!-- Secondary metrics row -->
        <div class="cards-grid cards-secondary">
            <div class="card card-compact">
                <div class="card-label">Cash Reserves</div>
                <div class="card-value" style="color:#4ade80; font-size:1.2rem;">$40,670</div>
                <div class="card-sub">Emergency fund</div>
            </div>
            <div class="card card-compact">
                <div class="card-label">Annual Expenses</div>
                <div class="card-value yellow" style="font-size:1.2rem;">$113,598</div>
                <div class="card-sub">2025 baseline</div>
            </div>
            <div class="card card-compact">
                <div class="card-label">PERS Pension</div>
                <div class="card-value green" style="font-size:1.2rem;" id="pensionPreview">$74,170/yr</div>
                <div class="card-sub" id="pensionSubtext">At Travis's retirement</div>
                <div class="card-sub" id="pensionReduction" style="color: #f87171;"></div>
            </div>
            <div class="card card-compact">
                <div class="card-label">Rental Income</div>
                <div class="card-value orange" style="font-size:1.2rem;" id="rentalIncomePreview">$0/yr</div>
                <div class="card-sub" id="rentalIncomeSubtext">Current net (2 properties)</div>
            </div>
        </div>

        <!-- SECTION: What We Have -->
        <div style="margin: 25px 0 10px 0; padding-left: 5px; font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px;">
            üìã What the household has today
        </div>

        <!-- Person Breakdown (Mike & Travis accounts) + Household Assets -->
        <div class="collapsible-section" id="section-household-assets">
            <div class="collapsible-header" onclick="toggleSection('household-assets')">
                <h3>üí∞ Accounts & Assets Overview</h3>
                <span class="collapse-icon" id="toggle-household-assets">‚ñº</span>
            </div>
            <div class="collapsible-content" id="content-household-assets">
                <!-- Mike & Travis Retirement Accounts -->
                <div class="person-section">
                    <div class="person-card">
                        <div class="person-name mike">üë§ Mike (Age 44)</div>
                        <div class="account-list">
                            <div class="account-item" style="font-size:0.75rem;color:var(--text-muted);padding-bottom:2px;border-bottom:1px solid rgba(255,255,255,0.05);">
                                <span>RETIREMENT ACCOUNTS</span>
                            </div>
                            <div class="account-item">
                                <span class="account-name">403B/401A (Peacehealth)</span>
                                <span class="account-value">$216,204</span>
                            </div>
                            <div class="account-item">
                                <span class="account-name">401K (Current)</span>
                                <span class="account-value">$25,408</span>
                            </div>
                            <div class="account-item">
                                <span class="account-name">Roth IRA</span>
                                <span class="account-value">$2,612</span>
                            </div>
                            <div class="account-item">
                                <span class="account-name">Annual Contributions</span>
                                <span class="account-value green" id="mikeContribDisplay">$19,560</span>
                            </div>
                            <div class="account-item" style="font-weight: 600;">
                                <span class="account-name">Retirement Total</span>
                                <span class="account-value blue">$244,224</span>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-size: 0.8rem; color: #a78bfa; font-weight: 600;">üìã No Pension</div>
                            <div style="font-size: 0.7rem; color: #888; margin-top: 4px;">
                                Relies on 401k/403b + Social Security at 67
                            </div>
                        </div>
                    </div>
                    <div class="person-card">
                        <div class="person-name travis">üë§ Travis (Age 36)</div>
                        <div class="account-list">
                            <div class="account-item" style="font-size:0.75rem;color:var(--text-muted);padding-bottom:2px;border-bottom:1px solid rgba(255,255,255,0.05);">
                                <span>RETIREMENT ACCOUNTS</span>
                            </div>
                            <div class="account-item">
                                <span class="account-name">457B (LRAPA)</span>
                                <span class="account-value">$29,618</span>
                            </div>
                            <div class="account-item">
                                <span class="account-name">Voya Pension (401k)</span>
                                <span class="account-value">$23,308</span>
                            </div>
                            <div class="account-item">
                                <span class="account-name">Sinclair</span>
                                <span class="account-value">$17,938</span>
                            </div>
                            <div class="account-item">
                                <span class="account-name">Roth IRA</span>
                                <span class="account-value">$1,000</span>
                            </div>
                            <div class="account-item">
                                <span class="account-name">PERS IAP</span>
                                <span class="account-value">$18,000</span>
                            </div>
                            <div class="account-item">
                                <span class="account-name">Annual Contributions</span>
                                <span class="account-value green" id="travisContribDisplay">$31,100</span>
                            </div>
                            <div class="account-item" style="font-weight: 600;">
                                <span class="account-name">Retirement Total</span>
                                <span class="account-value green">$89,864</span>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-size: 0.8rem; color: #fbbf24; font-weight: 600;">üèõÔ∏è Oregon PERS Pension (OPSRP)</div>
                            <div style="font-size: 0.7rem; color: #888; margin-top: 4px;">
                                1.5% √ó years √ó final avg salary<br>
                                Started: Oct 2022 | Vesting: Oct 2027 | Salary: $152K
                            </div>
                            <div style="font-size: 0.65rem; color: #f87171; margin-top: 6px; padding: 6px; background: rgba(248,113,113,0.1); border-radius: 4px;">
                                <strong>Early Penalty:</strong> Normal age 65 (or 58 w/30 yrs) | Age 60: ~40% reduction | Age 55: ~61% reduction
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Brokerage, Cash, Vehicles -->
                <div class="person-section" style="margin-top:15px;">
                    <div class="person-card">
                        <div class="person-name" style="color:#4facfe;">üìà Brokerage Investments</div>
                        <div class="account-list">
                            <div class="account-item">
                                <span class="account-name">Schwab (stocks)</span>
                                <span class="account-value" style="color:#4facfe;">$91,109</span>
                            </div>
                            <div class="account-item">
                                <span class="account-name">ComputerShare (NKE)</span>
                                <span class="account-value" style="color:#4facfe;">$56,031</span>
                            </div>
                            <div class="account-item">
                                <span class="account-name">E*Trade</span>
                                <span class="account-value" style="color:#4facfe;">$1,555</span>
                            </div>
                            <div class="account-item" style="font-weight:600;">
                                <span class="account-name">Total Brokerage</span>
                                <span class="account-value" style="color:#4facfe;">$148,695</span>
                            </div>
                        </div>
                        <div style="margin-top:8px; font-size:0.7rem; color:var(--text-muted);">
                            Included in portfolio growth projection
                        </div>
                    </div>
                    <div class="person-card">
                        <div class="person-name" style="color:#4ade80;">üè¶ Cash & Savings</div>
                        <div class="account-list">
                            <div class="account-item">
                                <span class="account-name">Cap One Checking</span>
                                <span class="account-value" style="color:#4ade80;">$2,900</span>
                            </div>
                            <div class="account-item">
                                <span class="account-name">Cap One Savings</span>
                                <span class="account-value" style="color:#4ade80;">$36,000</span>
                            </div>
                            <div class="account-item">
                                <span class="account-name">Peak / Selco / Cash</span>
                                <span class="account-value" style="color:#4ade80;">$1,770</span>
                            </div>
                            <div class="account-item" style="font-weight:600;">
                                <span class="account-name">Total Cash</span>
                                <span class="account-value" style="color:#4ade80;">$40,670</span>
                            </div>
                        </div>
                        <div style="margin-top:8px; font-size:0.7rem; color:var(--text-muted);">
                            Emergency fund ‚Äî not in portfolio projection
                        </div>
                    </div>
                </div>

                <!-- Vehicles & Net Worth -->
                <div class="person-section" style="margin-top:15px;">
                    <div class="person-card">
                        <div class="person-name" style="color:#fb923c;">üöó Vehicles</div>
                        <div class="account-list">
                            <div class="account-item">
                                <span class="account-name">Tucson</span>
                                <span class="account-value" style="color:#fb923c;">$20,825</span>
                            </div>
                            <div class="account-item" style="font-size:0.8rem;">
                                <span class="account-name" style="color:var(--text-muted);">‚îî Loan remaining</span>
                                <span class="account-value" style="color:#f87171;">‚àí$2,180</span>
                            </div>
                            <div class="account-item">
                                <span class="account-name">Polestar</span>
                                <span class="account-value" style="color:#fb923c;">$17,170</span>
                            </div>
                            <div class="account-item" style="font-size:0.8rem;">
                                <span class="account-name" style="color:var(--text-muted);">‚îî Loan remaining</span>
                                <span class="account-value" style="color:#f87171;">‚àí$10,527</span>
                            </div>
                            <div class="account-item" style="font-weight:600;">
                                <span class="account-name">Net Vehicle Equity</span>
                                <span class="account-value" style="color:#fb923c;">$25,288</span>
                            </div>
                        </div>
                    </div>
                    <div class="person-card">
                        <div class="person-name" style="color:#c084fc;">üìä Net Worth Summary</div>
                        <div class="account-list">
                            <div class="account-item">
                                <span class="account-name">Retirement + PERS IAP</span>
                                <span class="account-value" id="nwRetirement">$0</span>
                            </div>
                            <div class="account-item">
                                <span class="account-name">Brokerage Investments</span>
                                <span class="account-value" id="nwBrokerage">$0</span>
                            </div>
                            <div class="account-item">
                                <span class="account-name">Cash Reserves</span>
                                <span class="account-value" id="nwCash">$0</span>
                            </div>
                            <div class="account-item">
                                <span class="account-name">Real Estate Equity</span>
                                <span class="account-value" id="nwRealEstate">$0</span>
                            </div>
                            <div class="account-item" style="font-size:0.75rem; color:var(--text-muted);">
                                <span class="account-name">&nbsp;&nbsp;Home equity</span>
                                <span class="account-value" id="nwHomeEquity">$0</span>
                            </div>
                            <div class="account-item" style="font-size:0.75rem; color:var(--text-muted);">
                                <span class="account-name">&nbsp;&nbsp;Danebo equity</span>
                                <span class="account-value" id="nwDaneboEquity">$0</span>
                            </div>
                            <div class="account-item" style="font-size:0.75rem; color:var(--text-muted);">
                                <span class="account-name">&nbsp;&nbsp;Century equity</span>
                                <span class="account-value" id="nwCenturyEquity">$0</span>
                            </div>
                            <div class="account-item">
                                <span class="account-name">Vehicle Equity</span>
                                <span class="account-value" id="nwVehicles">$0</span>
                            </div>
                            <div class="account-item" style="font-weight:600; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1);">
                                <span class="account-name">Household Net Worth</span>
                                <span class="account-value" style="color:#c084fc;" id="netWorthTotal">$0</span>
                            </div>
                        </div>
                        <div style="margin-top:8px; font-size:0.7rem; color:var(--text-muted);">
                            All values calculated from inputs above ‚Äî change a number and this updates.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION: What-If Controls -->
        <div style="margin: 25px 0 10px 0; padding-left: 5px; font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px;">
            üéõÔ∏è Adjust your plan
        </div>

        <!-- Retirement Age Controls -->
        <div class="collapsible-section" id="section-retirement-ages">
            <div class="collapsible-header" onclick="toggleSection('retirement-ages')">
                <h3>üë• Retirement Ages & Contributions</h3>
                <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="collapsible-content">
            <div class="controls-grid">
                <div class="control-group">
                    <div class="control-label">
                        <span>Mike's Retirement Age</span>
                        <span class="info-tip">?<span class="tooltip">When Mike stops working. Earlier retirement means more years in retirement but less time to save. Mike doesn't have a pension, so portfolio income is key.</span></span>
                    </div>
                    <div class="input-group">
                        <input type="number" id="mikeRetireAge" min="50" max="67" step="1" value="62">
                        <span class="unit">years old</span>
                    </div>
                    <div class="helper-text">
                        Currently 44 ‚Üí retires in <span id="mikeYearsToRetire">16</span> years (year <span id="mikeRetireYear">2042</span>)
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Travis's Retirement Age</span>
                        <span class="info-tip">?<span class="tooltip">When Travis stops working. Earlier retirement reduces PERS years of service. Retiring before 55 defers pension collection. Age 55 = 39% of full benefit; Age 60 = 60%; Age 65 = 100%.</span></span>
                    </div>
                    <div class="input-group">
                        <input type="number" id="travisRetireAge" min="50" max="67" step="1" value="62">
                        <span class="unit">years old</span>
                    </div>
                    <div class="helper-text">
                        Currently 36 ‚Üí retires in <span id="travisYearsToRetire">24</span> years (year <span id="travisRetireYear">2050</span>)
                    </div>
                </div>
            </div>

            <div class="controls-subtitle">üí∞ Current Salaries</div>
            <div class="controls-grid">
                <div class="control-group">
                    <div class="control-label">
                        <span>Mike's Salary</span>
                        <span class="info-tip">?<span class="tooltip">Mike's current gross annual salary. Used to show working income in the income vs. expenses comparison. Grows with the salary growth rate below.</span></span>
                    </div>
                    <div class="number-input-group">
                        <span class="currency-prefix">$</span>
                        <input type="number" id="mikeSalary" min="0" max="500000" step="5000" value="170000">
                        <span class="input-suffix">/year</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Travis's Salary</span>
                        <span class="info-tip">?<span class="tooltip">Travis's current gross annual salary (LRAPA). Also used for PERS pension calculations. Grows with the salary growth rate below.</span></span>
                    </div>
                    <div class="number-input-group">
                        <span class="currency-prefix">$</span>
                        <input type="number" id="travisSalary" min="0" max="500000" step="5000" value="152000">
                        <span class="input-suffix">/year</span>
                    </div>
                </div>
            </div>

            <div class="controls-subtitle">üíµ Annual Contributions</div>
            <div class="controls-grid">
                <div class="control-group">
                    <div class="control-label">
                        <span>Mike's Annual Contributions</span>
                    </div>
                    <div class="number-input-group">
                        <span class="currency-prefix">$</span>
                        <input type="number" id="mikeContrib" class="contrib-input mike-border" min="0" max="100000" step="500" value="19560">
                        <span class="input-suffix">/year</span>
                    </div>
                    <div style="font-size:0.65rem; color:var(--text-muted); margin-top:4px;">
                        403B + Roth IRA + 401K
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Travis's Annual Contributions</span>
                    </div>
                    <div class="number-input-group">
                        <span class="currency-prefix">$</span>
                        <input type="number" id="travisContrib" class="contrib-input travis-border" min="0" max="100000" step="500" value="31100">
                        <span class="input-suffix">/year</span>
                    </div>
                    <div style="font-size:0.65rem; color:var(--text-muted); margin-top:4px;">
                        457B + Voya + Sinclair + Roth + PERS IAP
                    </div>
                </div>
            </div>

            <div class="controls-subtitle">üìÖ Planned Contribution Changes <span style="font-size:0.7rem;color:var(--text-muted);">(optional)</span></div>
            <div class="note-box info" style="margin-bottom:15px;">
                <strong>How this works:</strong> Enter an annual increase (or decrease) for a specific year.
                The change is added to their current contribution at that time, and then continues
                growing by the "Annual Contribution Growth %" rate each year after.
                <br><br>
                <strong>Example:</strong> Mike contributes $19,560/yr now. In 2030, he pays off his car and can add $500/mo more.
                Enter: Mike, 2030, +$6,000. From 2030 onward, his contributions become ~$25,560 and grow by 2%/yr.
            </div>
            <div class="changes-table-container">
                <div id="changesTableContainer">
                    <div class="empty-changes" id="emptyChangesMsg">No planned changes. Click "Add Change" to model a future adjustment.</div>
                    <table class="changes-table" id="changesTable" style="display:none;">
                        <thead>
                            <tr>
                                <th>Person</th>
                                <th>Year</th>
                                <th>Annual +/- Amount</th>
                                <th>Note (optional)</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="changesTableBody">
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 15px; display: flex; align-items: center;">
                    <button class="btn-add" id="addChangeBtn" onclick="addContributionChange()">
                        <span>+</span> Add Change
                    </button>
                    <span class="changes-count" id="changesCount">0 of 5 changes</span>
                </div>
            </div>

            <div class="controls-subtitle">üìà Investment Assumptions</div>
            <div class="controls-grid">
                <div class="control-group">
                    <div class="control-label">
                        <span>Expected Annual Return</span>
                        <span class="info-tip">?<span class="tooltip">Pre-tax, pre-inflation return on the portfolio. Historical stock average is ~10%, but a 6-7% assumption is more conservative for planning. Higher returns look better but add risk.</span></span>
                    </div>
                    <div class="input-group">
                        <input type="number" id="returnRate" min="3" max="10" step="0.5" value="6">
                        <span class="unit">%</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Inflation Rate</span>
                        <span class="info-tip">?<span class="tooltip">Expected annual increase in cost of living. 2-3% is typical. Higher inflation erodes purchasing power‚Äîexpenses will double roughly every 24 years at 3%.</span></span>
                    </div>
                    <div class="input-group">
                        <input type="number" id="inflationRate" min="1" max="5" step="0.5" value="3">
                        <span class="unit">%</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Withdrawal Rate</span>
                        <span class="info-tip">?<span class="tooltip">The "safe withdrawal rate" from the portfolio. The 4% rule is traditional, but 3-3.5% is more conservative for early retirees. Lower rates = portfolio lasts longer but less annual income.</span></span>
                    </div>
                    <div class="input-group">
                        <input type="number" id="withdrawalRate" min="2.5" max="5" step="0.25" value="3.5">
                        <span class="unit">%</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Federal Tax Rate</span>
                        <span class="info-tip">?<span class="tooltip">Federal income tax on pension and 401k/403b withdrawals. At ~$150-200K household retirement income, the effective rate is ~18-22% after the standard deduction ($30,000 for married filing jointly). This also applies to ~85% of Social Security benefits above $44K combined income.</span></span>
                    </div>
                    <div class="input-group">
                        <input type="number" id="federalTaxRate" min="0" max="30" step="0.5" value="18">
                        <span class="unit">%</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Oregon State Tax Rate</span>
                        <span class="info-tip">?<span class="tooltip">Oregon taxes pension and 401k/403b withdrawals as regular income (~8% effective). Oregon does NOT tax Social Security benefits.</span></span>
                    </div>
                    <div class="input-group">
                        <input type="number" id="oregonTaxRate" min="0" max="12" step="0.5" value="8">
                        <span class="unit">%</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Annual Contribution Growth</span>
                        <span class="info-tip">?<span class="tooltip">Each year, contributions increase by this %. This models raises or automatic increases. If you add a "Planned Change" above, that new amount becomes the base, and this growth rate then applies to it going forward.</span></span>
                    </div>
                    <div class="input-group">
                        <input type="number" id="contribIncrease" min="0" max="5" step="0.5" value="2">
                        <span class="unit">%</span>
                    </div>
                </div>
            </div>

            <div class="controls-subtitle">üí∞ Retirement Expenses & Income</div>
            <div class="controls-grid">
                <div class="control-group">
                    <div class="control-label">
                        <span>Expense Reduction in Retirement</span>
                        <span class="info-tip">?<span class="tooltip">Many expenses drop in retirement: no commuting, work clothes, or payroll taxes. 10-20% reduction is typical. Don't over-estimate‚Äîhealthcare often increases.</span></span>
                    </div>
                    <div class="input-group">
                        <input type="number" id="expenseReduction" min="0" max="40" step="5" value="15">
                        <span class="unit">%</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Salary Growth (PERS FAS)</span>
                        <span class="info-tip">?<span class="tooltip">Travis's expected annual salary increases. This affects the "Final Average Salary" used in PERS pension calculation. Higher growth = higher eventual pension.</span></span>
                    </div>
                    <div class="input-group">
                        <input type="number" id="salaryGrowth" min="0" max="5" step="0.5" value="2">
                        <span class="unit">%</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Pre-Medicare Healthcare (per person)</span>
                        <span class="info-tip">?<span class="tooltip">Annual cost for health insurance before age 65 (Medicare eligibility). ACA marketplace plans can be $12,000-20,000/person. After 65, this drops significantly.</span></span>
                    </div>
                    <div class="input-group">
                        <span style="color:var(--text-muted);">$</span>
                        <input type="number" id="healthcareCost" min="0" max="30000" step="1000" value="15000">
                        <span class="unit">/year each</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>One-Time Expenses (total)</span>
                        <span class="info-tip">?<span class="tooltip">Big early retirement purchases: new car, home repairs, travel. Deducted from portfolio in first retirement year. Be conservative‚Äîearly retirees often underestimate.</span></span>
                    </div>
                    <div class="input-group">
                        <span style="color:var(--text-muted);">$</span>
                        <input type="number" id="oneTimeExpenses" min="0" max="200000" step="10000" value="50000">
                    </div>
                </div>
            </div>

            <div class="controls-subtitle">üèõÔ∏è Social Security</div>
            <div class="controls-grid">
                <div class="control-group">
                    <div class="control-label">
                        <span>Mike's SS (age 67, monthly)</span>
                        <span class="info-tip">?<span class="tooltip">Estimated Social Security at full retirement age (67). Check ssa.gov for estimates. This income starts at 67 regardless of when you retire early.</span></span>
                    </div>
                    <div class="input-group">
                        <span style="color:var(--text-muted);">$</span>
                        <input type="number" id="mikeSs" min="0" max="4000" step="100" value="2500">
                        <span class="unit">/mo</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Travis's SS (age 67, monthly)</span>
                        <span class="info-tip">?<span class="tooltip">Travis's expected Social Security benefit at age 67. Higher earners typically get $3,000-4,500/month. Combined with PERS, this is a significant income boost.</span></span>
                    </div>
                    <div class="input-group">
                        <span style="color:var(--text-muted);">$</span>
                        <input type="number" id="travisSs" min="0" max="4500" step="100" value="3500">
                        <span class="unit">/mo</span>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- Rental Properties Section -->
        <div class="collapsible-section" id="section-rentals">
            <div class="collapsible-header" onclick="toggleSection('rentals')">
                <h3>üè† Rental Properties</h3>
                <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="collapsible-content">
            <div class="controls-subtitle" style="margin-top:0;border-top:none;padding-top:0;">üìä Rental Assumptions</div>
            <div class="controls-grid">
                <div class="control-group">
                    <div class="control-label">
                        <span>Rent Growth Rate</span>
                        <span class="info-tip">?<span class="tooltip">Annual increase in rent. Historical average is 3-4%. The rentals just increased‚ÄîDanebo to $2,095. Growth compounds significantly over time.</span></span>
                    </div>
                    <div class="input-group">
                        <input type="number" id="rentGrowth" min="0" max="7" step="0.5" value="3.5">
                        <span class="unit">%</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Vacancy Rate</span>
                        <span class="info-tip">?<span class="tooltip">Percentage of time the property sits empty between tenants. 3% ‚âà 11 days/year turnover. Eugene's rental market is strong with low vacancy ‚Äî your actual experience has been near zero. Increase to 5-8% to stress-test or if you expect more turnover.</span></span>
                    </div>
                    <div class="input-group">
                        <input type="number" id="vacancyRate" min="0" max="20" step="1" value="3">
                        <span class="unit">%</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Property Appreciation</span>
                        <span class="info-tip">?<span class="tooltip">Annual increase in property value. Used for sale proceeds calculations. 3% is conservative; Eugene has seen higher historically.</span></span>
                    </div>
                    <div class="input-group">
                        <input type="number" id="propertyAppreciation" min="0" max="6" step="0.5" value="3">
                        <span class="unit">%</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Maintenance (% of value/yr)</span>
                        <span class="info-tip">?<span class="tooltip">Annual budget for repairs and upkeep as a percentage of property value. The "1% rule" is a common guideline but can overstate costs on well-maintained homes ‚Äî at $400K that's $4,000/yr per property. 0.5% (~$2,000/yr) is more realistic for your properties. Increase if expecting a roof, HVAC, or other major expense soon.</span></span>
                    </div>
                    <div class="input-group">
                        <input type="number" id="maintenanceRate" min="0.25" max="3" step="0.25" value="0.5">
                        <span class="unit">%</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Property Management Fee</span>
                        <span class="info-tip">?<span class="tooltip">Fee paid to your property manager (% of gross rent). You currently pay 8%. Set to 0% to see how much you'd save by self-managing. 10% is typical for full-service management.</span></span>
                    </div>
                    <div class="input-group">
                        <input type="number" id="propMgmtFee" min="0" max="12" step="1" value="8">
                        <span class="unit">%</span>
                    </div>
                </div>
            </div>

            <div class="controls-subtitle">üèòÔ∏è Property Details & Options</div>
            <div class="rental-cards">
                <!-- Danebo Property Card -->
                <div class="rental-card">
                    <div class="rental-card-header">
                        <div>
                            <div class="rental-card-title">üè° Danebo</div>
                            <div class="rental-card-address">526 N Danebo Ave, Eugene</div>
                        </div>
                        <span class="rental-status active" id="daneboStatus">Active</span>
                    </div>
                    <div class="rental-stats">
                        <div class="rental-stat">
                            <span class="rental-stat-label">Monthly Rent</span>
                            <span class="rental-stat-value">$2,095</span>
                        </div>
                        <div class="rental-stat">
                            <span class="rental-stat-label">Market Value</span>
                            <span class="rental-stat-value" id="daneboValue">$410,100</span>
                        </div>
                        <div class="rental-stat">
                            <span class="rental-stat-label">Monthly Mortgage</span>
                            <span class="rental-stat-value">$739/mo</span>
                        </div>
                        <div class="rental-stat">
                            <span class="rental-stat-label">Payoff Year</span>
                            <span class="rental-stat-value" id="daneboPayoff">2050</span>
                        </div>
                    </div>
                    <div class="rental-input-row">
                        <label>Extra Principal:</label>
                        <span style="color:var(--text-secondary);">$</span>
                        <input type="number" id="daneboExtraPrincipal" min="0" max="2000" step="50" value="0">
                        <span style="font-size:0.7rem;color:var(--text-muted);">/mo</span>
                    </div>
                    <div class="rental-input-row">
                        <label>
                            <input type="checkbox" id="daneboSell" onchange="toggleSellOptions('danebo')">
                            Sell this property
                        </label>
                    </div>
                    <div class="sell-options hidden" id="daneboSellOptions">
                        <label>Sell in year: </label>
                        <input type="number" id="daneboSellYear" min="2026" max="2060" value="2035">
                        <div style="margin-top:5px;color:#f87171;" id="daneboCapGains"></div>
                        <div style="margin-top:10px;padding:8px;background:rgba(79,172,254,0.1);border-radius:6px;">
                            <label style="display:flex;align-items:center;gap:8px;font-size:0.8rem;">
                                <input type="checkbox" id="daneboInvestProceeds" checked onchange="update()">
                                Invest proceeds into portfolio
                            </label>
                            <div style="margin-top:6px;display:flex;align-items:center;gap:6px;font-size:0.8rem;">
                                <span style="color:var(--text-secondary);">Amount:</span>
                                <span style="color:var(--text-muted);">$</span>
                                <input type="number" id="daneboInvestAmount" min="0" max="500000" step="5000" value="0" style="width:90px;" onchange="update()" oninput="update()">
                            </div>
                        </div>
                    </div>
                    <div class="rental-net-income">
                        <span style="font-size:0.75rem;color:var(--text-secondary);">Household Annual Net Income:</span>
                        <span class="rental-stat-value green" id="daneboNetIncome">$0</span>
                    </div>
                </div>

                <!-- Century Property Card -->
                <div class="rental-card">
                    <div class="rental-card-header">
                        <div>
                            <div class="rental-card-title">üè° Century</div>
                            <div class="rental-card-address">3703 Century Dr, Eugene</div>
                        </div>
                        <span class="rental-status active" id="centuryStatus">Active</span>
                    </div>
                    <div class="rental-stats">
                        <div class="rental-stat">
                            <span class="rental-stat-label">Monthly Rent</span>
                            <span class="rental-stat-value">$2,195</span>
                        </div>
                        <div class="rental-stat">
                            <span class="rental-stat-label">Market Value</span>
                            <span class="rental-stat-value" id="centuryValue">$383,300</span>
                        </div>
                        <div class="rental-stat">
                            <span class="rental-stat-label">Monthly Mortgage</span>
                            <span class="rental-stat-value">$720/mo</span>
                        </div>
                        <div class="rental-stat">
                            <span class="rental-stat-label">Payoff Year</span>
                            <span class="rental-stat-value" id="centuryPayoff">~2044</span>
                        </div>
                    </div>
                    <div class="rental-input-row">
                        <label>Extra Principal:</label>
                        <span style="color:var(--text-secondary);">$</span>
                        <input type="number" id="centuryExtraPrincipal" min="0" max="2000" step="50" value="125">
                        <span style="font-size:0.7rem;color:var(--text-muted);">/mo</span>
                    </div>
                    <div class="rental-input-row">
                        <label>
                            <input type="checkbox" id="centurySell" onchange="toggleSellOptions('century')">
                            Sell this property
                        </label>
                    </div>
                    <div class="sell-options hidden" id="centurySellOptions">
                        <label>Sell in year: </label>
                        <input type="number" id="centurySellYear" min="2026" max="2060" value="2035">
                        <div style="margin-top:5px;color:#f87171;" id="centuryCapGains"></div>
                        <div style="margin-top:10px;padding:8px;background:rgba(79,172,254,0.1);border-radius:6px;">
                            <label style="display:flex;align-items:center;gap:8px;font-size:0.8rem;">
                                <input type="checkbox" id="centuryInvestProceeds" checked onchange="update()">
                                Invest proceeds into portfolio
                            </label>
                            <div style="margin-top:6px;display:flex;align-items:center;gap:6px;font-size:0.8rem;">
                                <span style="color:var(--text-secondary);">Amount:</span>
                                <span style="color:var(--text-muted);">$</span>
                                <input type="number" id="centuryInvestAmount" min="0" max="500000" step="5000" value="0" style="width:90px;" onchange="update()" oninput="update()">
                            </div>
                        </div>
                    </div>
                    <div class="rental-net-income">
                        <span style="font-size:0.75rem;color:var(--text-secondary);">Household Annual Net Income:</span>
                        <span class="rental-stat-value green" id="centuryNetIncome">$0</span>
                    </div>
                </div>
            </div>

            <div class="note-box warning">
                <strong>üí° How net income is calculated:</strong> Gross rent minus vacancy allowance, 8% management fee, maintenance reserve, property tax, insurance, and mortgage P&I. Danebo includes a $228/mo furnace loan until 2029. To stress-test, try bumping vacancy to 8% or setting management to 0% to see the self-managing upside. After mortgage payoff, net income jumps significantly.
            </div>
            </div>
        </div>

        <!-- Primary Residence Section -->
        <div class="collapsible-section" id="section-home">
            <div class="collapsible-header" onclick="toggleSection('home')">
                <h3>üè° Primary Residence</h3>
                <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="collapsible-content">

            <div class="rental-cards">
                <div class="rental-card" style="border-left: 3px solid #60a5fa;">
                    <div class="rental-card-header">
                        <div>
                            <div class="rental-card-title" style="color:#60a5fa;">üè† Timberline Dr</div>
                            <div class="rental-card-address">2965 Timberline Dr, Eugene</div>
                        </div>
                        <span class="rental-status active" id="homeStatus">Primary Home</span>
                    </div>
                    <div class="rental-stats">
                        <div class="rental-stat">
                            <span class="rental-stat-label">Est. Value</span>
                            <span class="rental-stat-value" id="homeValue">$489,000</span>
                        </div>
                        <div class="rental-stat">
                            <span class="rental-stat-label">Equity</span>
                            <span class="rental-stat-value green" id="homeEquity">$119,828</span>
                        </div>
                        <div class="rental-stat">
                            <span class="rental-stat-label">Monthly Payment</span>
                            <span class="rental-stat-value">$864/mo</span>
                        </div>
                        <div class="rental-stat">
                            <span class="rental-stat-label">Payoff Year</span>
                            <span class="rental-stat-value" id="homePayoff">~2050</span>
                        </div>
                        <div class="rental-stat">
                            <span class="rental-stat-label">Interest Rate</span>
                            <span class="rental-stat-value green">2.75%</span>
                        </div>
                        <div class="rental-stat">
                            <span class="rental-stat-label">After Payoff</span>
                            <span class="rental-stat-value" id="homePostPayoff">$286/mo</span>
                        </div>
                    </div>
                    <div class="rental-input-row">
                        <label>Extra Principal:</label>
                        <span style="color:var(--text-secondary);">$</span>
                        <input type="number" id="homeExtraPrincipal" min="0" max="2000" step="50" value="0">
                        <span style="font-size:0.7rem;color:var(--text-muted);">/mo</span>
                    </div>
                    <div class="rental-input-row">
                        <label>
                            <input type="checkbox" id="homeSell" onchange="toggleSellOptions('home')">
                            Sell & downsize
                        </label>
                    </div>
                    <div class="sell-options hidden" id="homeSellOptions">
                        <label>Sell in year: </label>
                        <input type="number" id="homeSellYear" min="2026" max="2060" value="2035">
                        <div style="margin-top:8px;color:#4ade80;" id="homeProceeds"></div>
                        <div style="margin-top:12px;padding:10px;background:rgba(79,172,254,0.1);border-radius:6px;">
                            <label style="display:flex;align-items:center;gap:8px;font-size:0.8rem;">
                                <input type="checkbox" id="homeInvestProceeds" checked onchange="update()">
                                Invest proceeds into portfolio
                            </label>
                            <div style="margin-top:8px;display:flex;align-items:center;gap:8px;" id="homeInvestAmountRow">
                                <span style="font-size:0.8rem;color:var(--text-secondary);">Amount to invest:</span>
                                <span style="color:var(--text-muted);">$</span>
                                <input type="number" id="homeInvestAmount" min="0" max="1000000" step="10000" value="0" style="width:100px;" onchange="update()" oninput="update()">
                            </div>
                        </div>
                        <div style="margin-top:4px;font-size:0.7rem;color:var(--text-muted);">
                            üí° Primary residence: $500K capital gains exclusion for married couples (likely $0 tax).
                        </div>
                    </div>
                    <div style="margin-top:12px;padding:10px;background:rgba(96,165,250,0.1);border-radius:6px;font-size:0.75rem;">
                        <strong>üí° 2.75% rate is excellent!</strong> Below inflation, so accelerating payoff may not be the best use of capital.
                        Mortgage payment is included in the expense baseline.
                    </div>
                </div>

                <div class="rental-card" style="background:rgba(96,165,250,0.05);">
                    <div style="font-size:0.9rem;font-weight:600;color:#60a5fa;margin-bottom:15px;">üìä All Properties Summary</div>
                    <div class="rental-stats" style="grid-template-columns: 1fr;">
                        <div class="rental-stat" style="flex-direction:row;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05);">
                            <span class="rental-stat-label" style="font-size:0.8rem;">Total Real Estate Value</span>
                            <span class="rental-stat-value" id="totalRealEstateValue">$1,278,200</span>
                        </div>
                        <div class="rental-stat" style="flex-direction:row;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05);">
                            <span class="rental-stat-label" style="font-size:0.8rem;">Total Equity</span>
                            <span class="rental-stat-value green" id="totalEquity">$329,271</span>
                        </div>
                        <div class="rental-stat" style="flex-direction:row;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05);">
                            <span class="rental-stat-label" style="font-size:0.8rem;">Household Monthly Mortgage Payments</span>
                            <span class="rental-stat-value yellow" id="totalMortgages">$2,323/mo</span>
                        </div>
                        <div class="rental-stat" style="flex-direction:row;justify-content:space-between;padding:8px 0;">
                            <span class="rental-stat-label" style="font-size:0.8rem;">After All Paid Off</span>
                            <span class="rental-stat-value green" id="postPayoffCosts">~$572/mo</span>
                        </div>
                    </div>
                    <div class="helper-text">
                        <strong>Impact on Retirement:</strong> When mortgages are paid off, household expenses drop significantly. The model factors this into expense projections automatically.
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- SECTION: The Big Picture -->
        <div style="margin: 25px 0 10px 0; padding-left: 5px; font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px;">
            üìà The big picture
        </div>

        <!-- Chart -->
        <div class="result-card" style="margin-bottom: 20px;">
            <div class="result-title" style="color: #4ade80;">üìà Portfolio Growth Over Time</div>
            <div class="chart-container">
                <canvas id="projectionChart"></canvas>
            </div>
            <div style="font-size: 0.7rem; color: #666; margin-top: 10px;">
                Hover/tap points to see both ages. Vertical lines show retirement dates. Adjust settings above to see how changes affect the projection.
            </div>
        </div>

        <!-- SECTION: Detailed Analysis -->
        <div style="margin: 25px 0 10px 0; padding-left: 5px; font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px;">
            üìã Detailed analysis
        </div>

        <!-- Income & Expense Breakdown -->
        <div class="income-breakdown">
            <div class="result-title" style="color: #fbbf24;">üíµ Income vs. Expenses at Retirement <span id="incomeBreakdownSubtitle" style="font-size:0.8rem;color:var(--text-secondary);">(when both retired)</span></div>
            <div class="phase-tabs" id="phaseTabs"></div>
            <div class="bar-row-label">Income: <span id="incomeTotal"></span>/yr</div>
            <div id="incomeBarWrapper">
                <div class="income-bar" id="incomeBar"></div>
            </div>
            <div class="income-legend" id="incomeLegend"></div>
            <div class="bar-row-label">Expenses: <span id="expenseTotal"></span>/yr</div>
            <div id="expenseBarWrapper">
                <div class="expense-bar" id="expenseBar"></div>
            </div>
            <div class="expense-legend" id="expenseLegend"></div>
            <div class="surplus-indicator" id="surplusIndicator"></div>
        </div>

        <!-- Scenario Detail Table -->
        <div class="results-section" style="grid-template-columns: 1fr;">
            <div class="result-card">
                <div class="result-title" style="color: #4facfe;">üìä Retirement Phase Breakdown</div>
                <table class="scenarios-table">
                    <thead>
                        <tr>
                            <th>Phase</th>
                            <th>Years</th>
                            <th>Portfolio</th>
                            <th>Income Sources</th>
                            <th>vs Expenses</th>
                        </tr>
                    </thead>
                    <tbody id="scenariosBody">
                    </tbody>
                </table>
                <div style="font-size: 0.7rem; color: #666; margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05);">
                    <strong>How to read this:</strong> Each phase shows what happens as Mike and Travis retire at different times.
                    Contributions stop when each person retires. Social Security kicks in at 67.
                </div>
            </div>
        </div>

        <!-- How the Math Works -->
        <div style="margin-top: 30px; font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px;">üìñ How the math works</div>

        <div class="collapsible-section" id="section-math-explainer">
            <div class="collapsible-header" onclick="toggleSection('math-explainer')">
                <h3>Taxes, Rentals & Assumptions Explained <span class="collapse-icon">‚ñº</span></h3>
            </div>
            <div class="collapsible-content" id="content-math-explainer" style="font-size: 0.85rem; line-height: 1.7; color: var(--text-secondary);">

                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 8px; font-size: 0.95rem;">üí∞ Income Taxes in Retirement</h4>
                    <p>The dashboard applies two layers of income tax to retirement income:</p>
                    <p style="margin: 8px 0;"><strong>Federal income tax</strong> (default 18%) is applied to PERS pension, portfolio withdrawals (401k, 457b, etc.), and net rental profit. The 18% is a blended effective rate estimate ‚Äî actual rates depend on total income and deductions. This can be adjusted in the "Retirement Ages &amp; Contributions" section.</p>
                    <p style="margin: 8px 0;"><strong>Oregon state income tax</strong> (default 8%) is applied to the same income sources. Oregon's top marginal rate is ~9.9%, so 8% is a conservative effective rate. Also adjustable.</p>
                    <p style="margin: 8px 0;">Together, about <strong>26 cents of every dollar</strong> from pension, portfolio withdrawals, and rental profit goes to taxes. The remaining 74 cents is spendable income.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 8px; font-size: 0.95rem;">üèõÔ∏è Social Security Taxes</h4>
                    <p>Social Security has its own tax treatment. Oregon does <em>not</em> tax Social Security benefits at all.</p>
                    <p style="margin: 8px 0;">At the federal level, up to 85% of Social Security benefits are taxable ‚Äî but only if combined gross income (pension + withdrawals + rental income + Social Security) exceeds <strong>$44,000</strong> (the married-filing-jointly threshold). Below that, Social Security is tax-free.</p>
                    <p style="margin: 8px 0;">When above the threshold, the dashboard calculates: <em>SS benefit minus (85% &times; benefit &times; federal tax rate)</em>. For example, on $30,000/yr in Social Security at an 18% federal rate, roughly $4,590 goes to federal tax, leaving ~$25,410.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 8px; font-size: 0.95rem;">üè† Capital Gains on Property Sales</h4>
                    <p>When a property is sold, the profit (sale price minus purchase price) is subject to capital gains tax. The dashboard uses a combined rate of <strong>19%</strong> (15% federal long-term capital gains + ~4% Oregon state).</p>
                    <p style="margin: 8px 0;">For a <strong>primary residence</strong>, there is a significant exclusion: married couples can exclude up to <strong>$500,000 in gains</strong> from tax. So a home purchased for $351K and sold for $800K would owe zero capital gains tax, since the $449K gain falls under the exclusion.</p>
                    <p style="margin: 8px 0;">Rental properties do <strong>not</strong> qualify for this exclusion ‚Äî the full gain is taxable at 19%.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 8px; font-size: 0.95rem;">üèòÔ∏è How Rental Income Is Calculated</h4>
                    <p>Each rental property's net income follows this formula:</p>
                    <p style="margin: 8px 0; padding: 10px; background: var(--accent-light); border-radius: 8px; font-family: monospace; font-size: 0.8rem;">
                        Rent collected<br>
                        &minus; Vacancy loss (default 3% ‚Äî ~11 days/year turnover)<br>
                        &minus; Property management fee (default 8% of collected rent)<br>
                        &minus; Maintenance reserve (default 0.5% of property value/year)<br>
                        &minus; Property tax (increases ~2% per year)<br>
                        &minus; Insurance (increases ~2% per year)<br>
                        &minus; Mortgage principal &amp; interest (drops to $0 once paid off)<br>
                        &minus; Any special loans (e.g., Danebo furnace loan through 2029)<br>
                        = <strong>Net rental income</strong>
                    </p>
                    <p style="margin: 8px 0;">The defaults reflect current conditions: 8% management fee (what the property manager charges), 3% vacancy (Eugene's rental market has been consistently strong), and 0.5% maintenance (~$2K/property/year for routine upkeep). With these settings, the numbers should closely match actual bank deposits. Positive rental income is taxed at the combined ~26% rate in retirement projections.</p>
                    <p style="margin: 8px 0;"><strong>Stress-testing:</strong> Bump vacancy to 8% to simulate a rough year with a month empty between tenants, or set management to 0% to see the self-managing upside. These levers show how much cushion rental income has under different conditions.</p>
                    <p style="margin: 8px 0;">If a property shows <strong>negative</strong> in a stress test, it means rent wouldn't fully cover costs under those conditions. In practice, rental losses can often be <strong>deducted against other income</strong> on a tax return (up to $25K/year for active participants). The dashboard does not model that deduction, so actual take-home may be slightly better than shown.</p>
                    <p style="margin: 8px 0;"><strong>Why rentals improve over time:</strong> Once the mortgage is paid off, the largest expense disappears and the property flips to strongly positive cash flow. Rent also increases each year while the fixed-rate mortgage payment stays flat ‚Äî the spread widens every year.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 8px; font-size: 0.95rem;">üìä Why Mortgage, Tax &amp; Insurance Are Separated</h4>
                    <p>In real life, property tax and insurance are bundled into the monthly mortgage payment through escrow ‚Äî one payment covers principal, interest, tax, and insurance (often called PITI). The dashboard deliberately separates these into individual line items.</p>
                    <p style="margin: 8px 0;">The reason: when the mortgage is eventually paid off, the principal and interest go to zero ‚Äî but property tax and insurance remain ongoing costs. By tracking them separately, the dashboard can accurately model what expenses continue after payoff and what expenses stop. The total cost during the mortgage period comes out the same either way, but separating them ensures the post-payoff picture is correct.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 8px; font-size: 0.95rem;">üìà Portfolio Growth</h4>
                    <p>The investment portfolio (retirement accounts + brokerage) grows at the rate set in the controls (default 6%). This is a conservative estimate ‚Äî the long-term stock market average is 7-10%, but 6% accounts for a balanced portfolio that includes bonds and other lower-growth holdings.</p>
                    <p style="margin: 8px 0;">Contributions are modeled as mid-year additions, meaning money added during the year earns about half a year's growth. Contributions stop for each person in the year they retire. Withdrawals in retirement reduce the balance. The chart shows the projected trajectory including all contributions, withdrawals, and any property sale proceeds earmarked for investment.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 8px; font-size: 0.95rem;">üßÆ How Net Worth Is Calculated</h4>
                    <p>The net worth figure in the sidebar and header card is computed from the same data that drives every other part of the dashboard. Nothing is hardcoded ‚Äî every line is derived from the property values, mortgage balances, and account totals in the sections above. Here is the exact formula:</p>
                    <p style="margin: 8px 0; padding: 10px; background: var(--accent-light); border-radius: 8px; font-family: monospace; font-size: 0.8rem;">
                        <strong>Real estate equity</strong><br>
                        &nbsp;&nbsp;Home: market value &minus; mortgage balance<br>
                        &nbsp;&nbsp;Danebo: market value &minus; mortgage balance<br>
                        &nbsp;&nbsp;Century: market value &minus; mortgage balance<br>
                        <br>
                        + Retirement accounts (401K, 457b, PERS IAP)<br>
                        + Brokerage investments (Schwab, ComputerShare, E*Trade)<br>
                        + Cash reserves (checking, savings)<br>
                        + Vehicle equity (value &minus; remaining loans)<br>
                        <br>
                        = <strong>Household Net Worth</strong>
                    </p>
                    <p style="margin: 8px 0;">This is a <strong>full household</strong> view ‚Äî it includes 100% of every jointly owned asset. The sidebar breaks it down line by line so each component can be verified against account statements. If any number looks off, the property values and balances in the sections above are the inputs that drive the total.</p>
                    <p style="margin: 8px 0;">Net worth is a <em>point-in-time snapshot</em> based on today's balances. The retirement projections (chart and scenario table) model how the portfolio grows and gets drawn down over time, but they do not project future changes in property values or mortgage paydown into the net worth display.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 8px; font-size: 0.95rem;">üìä Expense Breakdown Categories</h4>
                    <p>The annual household expenses of $113,598 are decomposed into categories that evolve over time. Click the phase tabs in the "Income vs. Expenses" section above to see how each category changes at different retirement milestones.</p>
                    <p style="margin: 8px 0;"><strong>Mortgage P&amp;I ($13,772/yr)</strong> ‚Äî the principal and interest portion of the home mortgage payment. This is a fixed nominal amount that does not increase with inflation. It drops to $0 when the mortgage is paid off (around 2050, or sooner with extra payments). This is one of the most impactful transitions in retirement expenses.</p>
                    <p style="margin: 8px 0;"><strong>Property Tax &amp; Insurance ($6,871/yr)</strong> ‚Äî property tax ($6,094) and homeowners insurance ($777) on the primary residence. These grow with inflation and continue even after the mortgage is paid off.</p>
                    <p style="margin: 8px 0;"><strong>Living Expenses ($92,955/yr)</strong> ‚Äî everything else: food, utilities, transportation, entertainment, subscriptions, and so on. The retirement expense reduction slider (default 15%) applies only to this category ‚Äî mortgage and property costs are fixed obligations that cannot be reduced by lifestyle adjustments. After the 15% reduction, this starts at ~$79,012/yr and grows with inflation.</p>
                    <p style="margin: 8px 0;"><strong>Healthcare ($15,000/person/yr)</strong> ‚Äî estimated cost of health insurance premiums and out-of-pocket medical costs for each retired person before age 65. Once Medicare eligibility kicks in at 65, this cost drops to $0. This category only appears during the gap between retirement and Medicare.</p>
                    <p style="margin: 8px 0;"><strong>One-time Retirement Expenses</strong> ‚Äî a lump sum (default $50,000) spread over the first 5 years of full retirement ($10,000/yr). Covers deferred home projects, travel, or other transition costs that often arise when entering retirement.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 8px; font-size: 0.95rem;">‚öôÔ∏è Key Assumptions to Review</h4>
                    <p>Every number in this dashboard can be adjusted. The defaults are calibrated to current conditions. The most impactful ones to review:</p>
                    <p style="margin: 8px 0;"><strong>Portfolio growth rate</strong> (default 6%) ‚Äî conservative estimate for a balanced portfolio. The historical S&amp;P 500 average is higher (7-10%), but 6% provides a margin of safety. Adjust upward for a more aggressive allocation, or downward to stress-test.</p>
                    <p style="margin: 8px 0;"><strong>Inflation rate</strong> (default 3%) ‚Äî slightly above the Fed's 2% target. This compounds expenses over time: at 3%, today's $100K in annual expenses becomes ~$180K in 20 years.</p>
                    <p style="margin: 8px 0;"><strong>Retirement ages</strong> ‚Äî earlier retirement means fewer years of contributions, more years of withdrawals, and a reduced PERS pension. Each year earlier has a compounding effect.</p>
                    <p style="margin: 8px 0;"><strong>Rental assumptions</strong> ‚Äî management fee (8%) reflects the current property manager cost, vacancy (3%) reflects Eugene's strong rental market, and maintenance (0.5%) covers routine upkeep. Set management to 0% to model self-managing, or bump vacancy to 8% to stress-test a rough stretch.</p>
                    <p style="margin: 8px 0;">Small changes in any of these rates compound significantly over 20-30 years.</p>
                </div>

                <div style="padding: 12px; background: var(--accent-light); border-radius: 8px; border-left: 3px solid #4facfe; font-size: 0.8rem;">
                    <strong>A note on precision:</strong> This dashboard is a planning tool, not a tax calculator. Real taxes depend on deductions, brackets, filing status, and many other factors that change yearly. The rates used here are effective-rate estimates designed to give a realistic picture of take-home income. For exact tax planning, a tax professional should be consulted ‚Äî but these numbers should be within a reasonable ballpark for retirement planning purposes.
                </div>
            </div>
        </div>

        <div class="footer">
            Data sourced from Retirement Calc.xlsx, Net Worth Summary.xlsx, and Combined_Credit_Cards_2025_All.xlsx | Dashboard updated February 2026
        </div>
    </div>

    <script>
        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? null : 'dark';

            if (newTheme) {
                html.setAttribute('data-theme', 'dark');
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
                document.getElementById('themeLabel').textContent = 'Light';
            } else {
                html.removeAttribute('data-theme');
                document.getElementById('themeIcon').textContent = 'üåô';
                document.getElementById('themeLabel').textContent = 'Dark';
            }

            // Save preference
            localStorage.setItem('theme', newTheme || 'light');

            // Update chart colors if chart exists
            if (chart) {
                updateChartColors();
            }
        }

        // Load saved theme on page load
        function loadTheme() {
            const saved = localStorage.getItem('theme');
            if (saved === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
                document.getElementById('themeLabel').textContent = 'Light';
            }
        }

        // Update chart colors for theme
        function updateChartColors() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            const textColor = isDark ? '#888' : '#666';

            if (chart && chart.options) {
                chart.options.scales.x.grid.color = gridColor;
                chart.options.scales.y.grid.color = gridColor;
                chart.options.scales.x.ticks.color = textColor;
                chart.options.scales.y.ticks.color = textColor;
                chart.update('none');
            }
        }

        // Collapsible section toggle
        function toggleSection(sectionId) {
            const section = document.getElementById('section-' + sectionId);
            if (section) {
                section.classList.toggle('collapsed');
                // Save preference
                const collapsed = section.classList.contains('collapsed');
                localStorage.setItem('section-' + sectionId, collapsed ? 'collapsed' : 'expanded');
            }
        }

        // Load saved section states
        function loadSectionStates() {
            const sections = ['retirement-ages', 'rentals', 'home', 'household-assets', 'math-explainer'];
            sections.forEach(id => {
                const saved = localStorage.getItem('section-' + id);
                const section = document.getElementById('section-' + id);
                if (section && saved === 'collapsed') {
                    section.classList.add('collapsed');
                }
            });
        }

        // Base financial data
        const baseData = {
            // Retirement accounts: $316,088 + PERS IAP $18,000
            // Brokerage investments: Schwab $91,109 + ComputerShare $56,031 + ETrade $1,555
            currentPortfolio: 316088 + 18000 + 148695,  // $482,783 total investable
            cashReserves: 40670,        // Cap One checking/savings, Peak, Selco
            brokerageBreakdown: {
                schwab: 91109,          // Individual stocks (AAPL, NVDA, GOOGL, etc.)
                computerShare: 56031,   // NKE shares
                etrade: 1555            // E*Trade
            },
            vehicleLoans: {
                tucson: { value: 20825, loanBalance: 2180 },
                polestar: { value: 17170, loanBalance: 10527 }
            },
            annualExpenses: 113598,
            mikeAge: 44,
            travisAge: 36,
            mikeContributions: 19560,
            travisContributions: 31100,
            currentYear: 2026,
            // PERS parameters
            persStartYear: 2022.75,
            currentSalary: 152000,  // Travis (also used for PERS calc)
            mikeSalary: 170000,     // Mike (Peacehealth)
            persMultiplier: 0.015,
            // Ownership share of rentals (50/50 with Mike)
            rentalOwnership: 1.00,  // Full household view (Mike + Travis together)
            // Rental Properties
            rentals: {
                danebo: {
                    name: "Danebo",
                    address: "526 N Danebo Ave",
                    currentRent: 2095,           // Monthly (just increased Dec 2025)
                    marketValue: 410100,         // Updated from net worth summary
                    purchasePrice: 195000,
                    yearPurchased: 2015,
                    mortgageBalance: 204305,     // Updated from net worth summary
                    mortgagePayment: 1478.65,    // Monthly P+I+escrow (full)
                    mortgageRate: 0.0375,
                    mortgagePayoff: 2050,        // Standard payoff year
                    propertyTax: 3359,           // Annual
                    insurance: 1464,             // Annual
                    extraPrincipal: 0,           // Monthly extra payment
                    furnaceLoan: 228,            // Monthly furnace payment
                    furnaceLoanEnd: 2029         // When furnace loan ends
                },
                century: {
                    name: "Century",
                    address: "3703 Century Dr",
                    currentRent: 2195,           // Monthly
                    marketValue: 383300,         // Updated from net worth summary
                    purchasePrice: 224000,
                    yearPurchased: 2017,
                    mortgageBalance: 173051,     // Updated from net worth summary
                    mortgagePayment: 1314.49,    // Monthly P+I+escrow (full)
                    mortgageRate: 0.0375,
                    mortgagePayoff: 2050,        // Standard payoff (2044 with current extra)
                    propertyTax: 3297,           // Annual
                    insurance: 1223,             // Annual
                    extraPrincipal: 0,           // Controlled by UI input below
                    furnaceLoan: 0,
                    furnaceLoanEnd: null
                }
            },
            // Primary Residence (50/50 with Mike)
            primaryResidence: {
                name: "Timberline",
                address: "2965 Timberline Dr, Eugene",
                purchasePrice: 351400,
                currentValue: 489000,            // Updated from net worth summary
                mortgageBalance: 241938,         // Updated from net worth summary
                mortgagePayment: 1728.51,        // Monthly total (P+I+escrow+shortage)
                mortgagePI: 1147.65,             // Just P&I portion
                mortgageRate: 0.0275,            // 2.75% - excellent rate!
                mortgagePayoff: 2050,            // Standard payoff ~July 2050
                propertyTax: 6094,               // Annual (2025)
                insurance: 777,                  // Annual (2025)
                escrowShortage: 201.78,          // Being spread through Apr 2026
                // Note: mortgage is likely already included in the $113,598 annual expenses
                includedInExpenses: true
            }
        };

        let chart = null;

        // Contribution changes array (max 5)
        const MAX_CHANGES = 5;
        let contributionChanges = [];

        function addContributionChange() {
            if (contributionChanges.length >= MAX_CHANGES) return;

            contributionChanges.push({
                id: Date.now(),
                person: 'mike',
                year: baseData.currentYear + 2,
                amount: 6000,  // Default to +$6,000/yr (~$500/mo increase)
                note: ''
            });

            renderChangesTable();
            update();
        }

        function removeContributionChange(id) {
            contributionChanges = contributionChanges.filter(c => c.id !== id);
            renderChangesTable();
            update();
        }

        function updateContributionChange(id, field, value) {
            const change = contributionChanges.find(c => c.id === id);
            if (change) {
                if (field === 'year') {
                    change[field] = parseInt(value) || baseData.currentYear;
                } else if (field === 'amount') {
                    change[field] = parseFloat(value) || 0;
                } else {
                    change[field] = value;
                }
                update();
            }
        }

        function renderChangesTable() {
            const tbody = document.getElementById('changesTableBody');
            const table = document.getElementById('changesTable');
            const emptyMsg = document.getElementById('emptyChangesMsg');
            const countEl = document.getElementById('changesCount');
            const addBtn = document.getElementById('addChangeBtn');

            // Update count display
            countEl.textContent = `${contributionChanges.length} of ${MAX_CHANGES} changes`;

            // Enable/disable add button
            addBtn.disabled = contributionChanges.length >= MAX_CHANGES;

            if (contributionChanges.length === 0) {
                table.style.display = 'none';
                emptyMsg.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            emptyMsg.style.display = 'none';

            // Sort by year
            const sorted = [...contributionChanges].sort((a, b) => a.year - b.year);

            tbody.innerHTML = sorted.map(change => {
                const personClass = change.person === 'mike' ? 'person-mike' : 'person-travis';
                const personName = change.person === 'mike' ? 'Mike' : 'Travis';

                return `
                    <tr>
                        <td>
                            <select onchange="updateContributionChange(${change.id}, 'person', this.value)">
                                <option value="mike" ${change.person === 'mike' ? 'selected' : ''}>Mike</option>
                                <option value="travis" ${change.person === 'travis' ? 'selected' : ''}>Travis</option>
                            </select>
                        </td>
                        <td>
                            <input type="number" value="${change.year}" min="2026" max="2060"
                                   onchange="updateContributionChange(${change.id}, 'year', this.value)"
                                   oninput="updateContributionChange(${change.id}, 'year', this.value)">
                        </td>
                        <td>
                            <span style="color:var(--text-secondary);">+$</span>
                            <input type="number" value="${change.amount}" min="-50000" max="100000" step="500"
                                   onchange="updateContributionChange(${change.id}, 'amount', this.value)"
                                   oninput="updateContributionChange(${change.id}, 'amount', this.value)"
                                   style="width:70px;">
                            <span style="color:var(--text-muted);font-size:0.7rem;">/yr</span>
                        </td>
                        <td>
                            <input type="text" value="${change.note}" placeholder="e.g., Car paid off"
                                   style="width:120px;"
                                   onchange="updateContributionChange(${change.id}, 'note', this.value)">
                        </td>
                        <td>
                            <button class="btn-remove" onclick="removeContributionChange(${change.id})">‚úï</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Toggle sell options visibility
        function toggleSellOptions(property) {
            const checkbox = document.getElementById(property + 'Sell');
            const options = document.getElementById(property + 'SellOptions');
            const status = document.getElementById(property + 'Status');

            if (checkbox.checked) {
                options.classList.remove('hidden');
                if (status) {
                    status.textContent = 'Will Sell';
                    status.classList.remove('active');
                    status.classList.add('sold');
                }
            } else {
                options.classList.add('hidden');
                if (status) {
                    status.textContent = property === 'home' ? 'Primary Home' : 'Active';
                    status.classList.remove('sold');
                    status.classList.add('active');
                }
            }
            update();
        }

        // Calculate mortgage payoff year with extra principal
        function calculateMortgagePayoff(balance, monthlyPI, rate, extraPrincipal, currentYear) {
            if (balance <= 0) return currentYear;

            let remaining = balance;
            const monthlyRate = rate / 12;
            let months = 0;
            const maxMonths = 360; // 30 years max

            while (remaining > 0 && months < maxMonths) {
                const interest = remaining * monthlyRate;
                const principalPaid = (monthlyPI - interest) + extraPrincipal;
                remaining -= principalPaid;
                months++;
            }

            return currentYear + Math.ceil(months / 12);
        }

        // Calculate rental income for a specific year
        function calculateRentalIncomeForYear(year, inputs) {
            const ownership = baseData.rentalOwnership;
            let totalNetIncome = 0;
            let daneboIncome = 0;
            let centuryIncome = 0;
            let saleProceeds = 0;

            const yearsFromNow = year - baseData.currentYear;

            // Process each property
            ['danebo', 'century'].forEach(propKey => {
                const prop = baseData.rentals[propKey];
                const sellChecked = inputs[propKey + 'Sell'];
                const sellYear = inputs[propKey + 'SellYear'];
                const extraPrincipal = inputs[propKey + 'ExtraPrincipal'];

                // Check if property was sold before this year
                if (sellChecked && year >= sellYear) {
                    // Property sold - add sale proceeds in the sell year only
                    if (year === sellYear) {
                        const appreciatedValue = prop.marketValue * Math.pow(1 + inputs.propertyAppreciation, sellYear - baseData.currentYear);
                        const gain = appreciatedValue - prop.purchasePrice;
                        const capGainsTax = gain * 0.19; // 15% federal + ~4% Oregon state
                        saleProceeds += (appreciatedValue - capGainsTax) * ownership;
                    }
                    return; // No rental income from sold property
                }

                // Calculate payoff year with extra principal
                const fullExtraPrincipal = extraPrincipal; // Full property amount
                const payoffYear = calculateMortgagePayoff(
                    prop.mortgageBalance,
                    prop.mortgagePayment - (prop.propertyTax + prop.insurance) / 12, // Just P&I
                    prop.mortgageRate,
                    prop.extraPrincipal + fullExtraPrincipal,
                    baseData.currentYear
                );

                // Rent with growth
                const annualRent = prop.currentRent * 12 * Math.pow(1 + inputs.rentGrowth, yearsFromNow);

                // Effective rent after vacancy
                const effectiveRent = annualRent * (1 - inputs.vacancyRate);

                // Property value with appreciation
                const currentValue = prop.marketValue * Math.pow(1 + inputs.propertyAppreciation, yearsFromNow);

                // Expenses
                const management = effectiveRent * inputs.propMgmtFee;
                const maintenance = currentValue * inputs.maintenanceRate;
                const taxes = prop.propertyTax * Math.pow(1.02, yearsFromNow); // 2% annual increase
                const insurance = prop.insurance * Math.pow(1.02, yearsFromNow);

                // Mortgage P&I only (0 if paid off) ‚Äî tax & insurance tracked separately above
                const monthlyPI = prop.mortgagePayment - (prop.propertyTax + prop.insurance) / 12;
                let mortgageCost = 0;
                if (year < payoffYear) {
                    mortgageCost = monthlyPI * 12;
                }

                // Furnace loan (Danebo only)
                let furnaceCost = 0;
                if (prop.furnaceLoan > 0 && prop.furnaceLoanEnd && year < prop.furnaceLoanEnd) {
                    furnaceCost = prop.furnaceLoan * 12;
                }

                // Net operating income (full property)
                const noi = effectiveRent - management - maintenance - taxes - insurance - mortgageCost - furnaceCost;

                // Property net income
                const netIncome = noi * ownership;

                if (propKey === 'danebo') {
                    daneboIncome = netIncome;
                } else {
                    centuryIncome = netIncome;
                }

                totalNetIncome += netIncome;
            });

            return {
                totalNetIncome,
                daneboIncome,
                centuryIncome,
                saleProceeds
            };
        }

        // Get rental-specific inputs
        function getRentalInputValues() {
            return {
                rentGrowth: parseFloat(document.getElementById('rentGrowth').value) / 100,
                vacancyRate: parseFloat(document.getElementById('vacancyRate').value) / 100,
                propertyAppreciation: parseFloat(document.getElementById('propertyAppreciation').value) / 100,
                maintenanceRate: parseFloat(document.getElementById('maintenanceRate').value) / 100,
                propMgmtFee: parseFloat(document.getElementById('propMgmtFee').value) / 100,
                daneboExtraPrincipal: parseFloat(document.getElementById('daneboExtraPrincipal').value) || 0,
                centuryExtraPrincipal: parseFloat(document.getElementById('centuryExtraPrincipal').value) || 0,
                daneboSell: document.getElementById('daneboSell').checked,
                daneboSellYear: parseInt(document.getElementById('daneboSellYear').value) || 2035,
                daneboInvestProceeds: document.getElementById('daneboInvestProceeds').checked,
                daneboInvestAmount: parseFloat(document.getElementById('daneboInvestAmount').value) || 0,
                centurySell: document.getElementById('centurySell').checked,
                centurySellYear: parseInt(document.getElementById('centurySellYear').value) || 2035,
                centuryInvestProceeds: document.getElementById('centuryInvestProceeds').checked,
                centuryInvestAmount: parseFloat(document.getElementById('centuryInvestAmount').value) || 0,
                homeSell: document.getElementById('homeSell').checked,
                homeSellYear: parseInt(document.getElementById('homeSellYear').value) || 2035,
                homeInvestProceeds: document.getElementById('homeInvestProceeds').checked,
                homeInvestAmount: parseFloat(document.getElementById('homeInvestAmount').value) || 0
            };
        }

        // Update rental displays
        function updateRentalDisplays() {
            const r = getRentalInputValues();

            // Calculate payoff years
            const daneboPayoff = calculateMortgagePayoff(
                baseData.rentals.danebo.mortgageBalance,
                baseData.rentals.danebo.mortgagePayment - (baseData.rentals.danebo.propertyTax + baseData.rentals.danebo.insurance) / 12,
                baseData.rentals.danebo.mortgageRate,
                baseData.rentals.danebo.extraPrincipal + r.daneboExtraPrincipal,
                baseData.currentYear
            );
            const centuryPayoff = calculateMortgagePayoff(
                baseData.rentals.century.mortgageBalance,
                baseData.rentals.century.mortgagePayment - (baseData.rentals.century.propertyTax + baseData.rentals.century.insurance) / 12,
                baseData.rentals.century.mortgageRate,
                baseData.rentals.century.extraPrincipal + r.centuryExtraPrincipal,
                baseData.currentYear
            );

            document.getElementById('daneboPayoff').textContent = r.daneboSell ? 'Selling ' + r.daneboSellYear : daneboPayoff;
            document.getElementById('centuryPayoff').textContent = r.centurySell ? 'Selling ' + r.centurySellYear : '~' + centuryPayoff;

            // Calculate current year net income
            const currentIncome = calculateRentalIncomeForYear(baseData.currentYear, r);
            document.getElementById('daneboNetIncome').textContent = formatCurrency(currentIncome.daneboIncome);
            document.getElementById('centuryNetIncome').textContent = formatCurrency(currentIncome.centuryIncome);

            // Color code based on positive/negative
            document.getElementById('daneboNetIncome').className = 'rental-stat-value ' + (currentIncome.daneboIncome >= 0 ? 'green' : 'red');
            document.getElementById('centuryNetIncome').className = 'rental-stat-value ' + (currentIncome.centuryIncome >= 0 ? 'green' : 'red');

            // Update rental summary card at top
            const activeCount = (r.daneboSell ? 0 : 1) + (r.centurySell ? 0 : 1);
            document.getElementById('rentalIncomePreview').textContent = formatCurrency(currentIncome.totalNetIncome) + '/yr';
            document.getElementById('rentalIncomePreview').className = 'card-value ' + (currentIncome.totalNetIncome >= 0 ? 'orange' : 'red');
            document.getElementById('rentalIncomeSubtext').textContent = activeCount === 2 ? 'Current net (2 properties)' : activeCount === 1 ? 'Current net (1 property)' : 'No active rentals';

            // Update property values with appreciation
            document.getElementById('daneboValue').textContent = formatCurrency(baseData.rentals.danebo.marketValue);
            document.getElementById('centuryValue').textContent = formatCurrency(baseData.rentals.century.marketValue);

            // Calculate and display capital gains if selling
            if (r.daneboSell) {
                const yearsToSell = r.daneboSellYear - baseData.currentYear;
                const saleValue = baseData.rentals.danebo.marketValue * Math.pow(1 + r.propertyAppreciation, yearsToSell);
                const gain = saleValue - baseData.rentals.danebo.purchasePrice;
                const tax = gain * 0.19; // 15% federal + ~4% Oregon
                const netProceeds = (saleValue - tax) * ownership;

                // Auto-populate invest amount if empty
                const daneboInvestInput = document.getElementById('daneboInvestAmount');
                if (!daneboInvestInput.value || parseFloat(daneboInvestInput.value) === 0) {
                    daneboInvestInput.value = Math.round(netProceeds);
                }

                let investStatus = '';
                if (r.daneboInvestProceeds) {
                    const investAmt = parseFloat(daneboInvestInput.value) || 0;
                    investStatus = `<br><span style="color:#4facfe;">‚Üí Investing ${formatCurrency(investAmt)} in ${r.daneboSellYear}</span>`;
                } else {
                    investStatus = `<br><span style="color:var(--text-muted);">‚Üí Not investing proceeds</span>`;
                }

                document.getElementById('daneboCapGains').innerHTML =
                    `Sale value: ${formatCurrency(saleValue * ownership)}<br>` +
                    `Cap gains tax (~19%): ${formatCurrency(tax * ownership)}<br>` +
                    `Household net proceeds: ${formatCurrency(netProceeds)}` + investStatus;
            }

            if (r.centurySell) {
                const yearsToSell = r.centurySellYear - baseData.currentYear;
                const saleValue = baseData.rentals.century.marketValue * Math.pow(1 + r.propertyAppreciation, yearsToSell);
                const gain = saleValue - baseData.rentals.century.purchasePrice;
                const tax = gain * 0.19; // 15% federal + ~4% Oregon
                const netProceeds = (saleValue - tax) * ownership;

                // Auto-populate invest amount if empty
                const centuryInvestInput = document.getElementById('centuryInvestAmount');
                if (!centuryInvestInput.value || parseFloat(centuryInvestInput.value) === 0) {
                    centuryInvestInput.value = Math.round(netProceeds);
                }

                let investStatus = '';
                if (r.centuryInvestProceeds) {
                    const investAmt = parseFloat(centuryInvestInput.value) || 0;
                    investStatus = `<br><span style="color:#4facfe;">‚Üí Investing ${formatCurrency(investAmt)} in ${r.centurySellYear}</span>`;
                } else {
                    investStatus = `<br><span style="color:var(--text-muted);">‚Üí Not investing proceeds</span>`;
                }

                document.getElementById('centuryCapGains').innerHTML =
                    `Sale value: ${formatCurrency(saleValue * ownership)}<br>` +
                    `Cap gains tax (~19%): ${formatCurrency(tax * ownership)}<br>` +
                    `Household net proceeds: ${formatCurrency(netProceeds)}` + investStatus;
            }
        }

        // Update primary residence displays
        function updateHomeDisplays() {
            const homeExtraPrincipal = parseFloat(document.getElementById('homeExtraPrincipal').value) || 0;
            const r = getRentalInputValues();
            const ownership = baseData.rentalOwnership;
            const home = baseData.primaryResidence;

            // Calculate home payoff year with extra principal
            const fullExtraPrincipal = homeExtraPrincipal;
            const homePayoff = calculateMortgagePayoff(
                home.mortgageBalance,
                home.mortgagePI,
                home.mortgageRate,
                fullExtraPrincipal,
                baseData.currentYear
            );
            document.getElementById('homePayoff').textContent = '~' + homePayoff;

            // Home equity (current)
            const homeEquity = (home.currentValue - home.mortgageBalance) * ownership;
            document.getElementById('homeEquity').textContent = formatCurrency(homeEquity);
            document.getElementById('homeValue').textContent = formatCurrency(home.currentValue);

            // Post-payoff monthly cost (just tax + insurance)
            const postPayoffMonthly = ((home.propertyTax + home.insurance) / 12) * ownership;
            document.getElementById('homePostPayoff').textContent = formatCurrency(postPayoffMonthly) + '/mo';

            // Calculate home sale proceeds if selling
            if (r.homeSell) {
                const yearsToSell = r.homeSellYear - baseData.currentYear;
                const appreciatedValue = home.currentValue * Math.pow(1 + r.propertyAppreciation, yearsToSell);

                // Calculate remaining mortgage at time of sale
                const monthsToSell = yearsToSell * 12;
                let remainingMortgage = home.mortgageBalance;
                const monthlyPI = home.mortgagePI;
                const monthlyRate = home.mortgageRate / 12;
                for (let m = 0; m < monthsToSell && remainingMortgage > 0; m++) {
                    const interest = remainingMortgage * monthlyRate;
                    const principal = monthlyPI - interest + fullExtraPrincipal;
                    remainingMortgage = Math.max(0, remainingMortgage - principal);
                }

                // Gross proceeds after mortgage payoff
                const grossProceeds = appreciatedValue - remainingMortgage;

                // Capital gains (with $500K married couple exclusion for primary residence)
                const gain = appreciatedValue - home.purchasePrice;
                const taxableGain = Math.max(0, gain - 500000); // $500K exclusion
                const capGainsTax = taxableGain * 0.19; // 15% federal + ~4% Oregon state

                // Net proceeds
                const netProceeds = (grossProceeds - capGainsTax) * ownership;

                // Auto-populate invest amount field if it's 0 or empty
                const homeInvestInput = document.getElementById('homeInvestAmount');
                if (!homeInvestInput.value || parseFloat(homeInvestInput.value) === 0) {
                    homeInvestInput.value = Math.round(netProceeds);
                }

                // Build status text based on invest checkbox
                let investStatus = '';
                if (r.homeInvestProceeds) {
                    const investAmt = parseFloat(homeInvestInput.value) || 0;
                    investStatus = `<span style="color:#4facfe;">‚Üí Investing ${formatCurrency(investAmt)} into portfolio in ${r.homeSellYear}</span>`;
                } else {
                    investStatus = `<span style="color:var(--text-muted);">‚Üí Not investing proceeds (keeping as cash/other use)</span>`;
                }

                document.getElementById('homeProceeds').innerHTML =
                    `<strong>Estimated proceeds in ${r.homeSellYear}:</strong><br>` +
                    `Home value: ${formatCurrency(appreciatedValue)} (${(r.propertyAppreciation*100).toFixed(1)}%/yr appreciation)<br>` +
                    `Remaining mortgage: ${formatCurrency(remainingMortgage)}<br>` +
                    `Capital gains tax: ${formatCurrency(capGainsTax)} ${taxableGain === 0 ? '($500K exclusion applies)' : ''}<br>` +
                    `<strong>Household net proceeds: ${formatCurrency(netProceeds)}</strong><br>` +
                    investStatus;
            }

            // Calculate rental payoff years for totals
            const daneboPayoff = calculateMortgagePayoff(
                baseData.rentals.danebo.mortgageBalance,
                baseData.rentals.danebo.mortgagePayment - (baseData.rentals.danebo.propertyTax + baseData.rentals.danebo.insurance) / 12,
                baseData.rentals.danebo.mortgageRate,
                baseData.rentals.danebo.extraPrincipal + r.daneboExtraPrincipal,
                baseData.currentYear
            );
            const centuryPayoff = calculateMortgagePayoff(
                baseData.rentals.century.mortgageBalance,
                baseData.rentals.century.mortgagePayment - (baseData.rentals.century.propertyTax + baseData.rentals.century.insurance) / 12,
                baseData.rentals.century.mortgageRate,
                baseData.rentals.century.extraPrincipal + r.centuryExtraPrincipal,
                baseData.currentYear
            );

            // Total real estate value
            const totalValue = home.currentValue + baseData.rentals.danebo.marketValue + baseData.rentals.century.marketValue;
            document.getElementById('totalRealEstateValue').textContent = formatCurrency(totalValue);

            // Total equity
            const totalEquity = homeEquity +
                ((baseData.rentals.danebo.marketValue - baseData.rentals.danebo.mortgageBalance) * ownership) +
                ((baseData.rentals.century.marketValue - baseData.rentals.century.mortgageBalance) * ownership);
            document.getElementById('totalEquity').textContent = formatCurrency(totalEquity);

            // Total monthly mortgage payments
            const totalMortgages = (home.mortgagePayment + baseData.rentals.danebo.mortgagePayment + baseData.rentals.century.mortgagePayment) * ownership;
            document.getElementById('totalMortgages').textContent = formatCurrency(totalMortgages) + '/mo';

            // Post-payoff costs (all properties - just tax + insurance)
            const allPostPayoff = (
                (home.propertyTax + home.insurance) +
                (baseData.rentals.danebo.propertyTax + baseData.rentals.danebo.insurance) +
                (baseData.rentals.century.propertyTax + baseData.rentals.century.insurance)
            ) / 12 * ownership;
            document.getElementById('postPayoffCosts').textContent = '~' + formatCurrency(allPostPayoff) + '/mo';

            // Dynamic net worth calculation
            const daneboEquity = (baseData.rentals.danebo.marketValue - baseData.rentals.danebo.mortgageBalance) * ownership;
            const centuryEquity = (baseData.rentals.century.marketValue - baseData.rentals.century.mortgageBalance) * ownership;
            const vehicleEquity = (baseData.vehicleLoans.tucson.value - baseData.vehicleLoans.tucson.loanBalance) +
                (baseData.vehicleLoans.polestar.value - baseData.vehicleLoans.polestar.loanBalance);
            const retirementAccounts = 316088 + 18000; // 401K/IRA + PERS IAP
            const brokerageTotal = 91109 + 56031 + 1555; // Schwab + ComputerShare + ETrade
            const netWorth = totalEquity + baseData.currentPortfolio + baseData.cashReserves + vehicleEquity;

            // Update header card
            document.getElementById('netWorthCard').textContent = formatCurrency(netWorth);

            // Update sidebar breakdown ‚Äî every line is computed, nothing stale
            document.getElementById('nwRetirement').textContent = formatCurrency(retirementAccounts);
            document.getElementById('nwBrokerage').textContent = formatCurrency(brokerageTotal);
            document.getElementById('nwCash').textContent = formatCurrency(baseData.cashReserves);
            document.getElementById('nwRealEstate').textContent = formatCurrency(totalEquity);
            document.getElementById('nwHomeEquity').textContent = formatCurrency(homeEquity);
            document.getElementById('nwDaneboEquity').textContent = formatCurrency(daneboEquity);
            document.getElementById('nwCenturyEquity').textContent = formatCurrency(centuryEquity);
            document.getElementById('nwVehicles').textContent = formatCurrency(vehicleEquity);
            document.getElementById('netWorthTotal').textContent = formatCurrency(netWorth);
        }

        // Calculate mortgage savings for a specific year (how much less expense due to payoffs)
        function calculateMortgageSavings(year) {
            const homeExtraPrincipal = parseFloat(document.getElementById('homeExtraPrincipal').value) || 0;
            const r = getRentalInputValues();
            const ownership = baseData.rentalOwnership;
            const home = baseData.primaryResidence;

            let savings = 0;

            // Home mortgage payoff
            const homePayoff = calculateMortgagePayoff(
                home.mortgageBalance, home.mortgagePI, home.mortgageRate,
                homeExtraPrincipal, baseData.currentYear
            );
            if (year >= homePayoff) {
                // Mortgage paid off - save the P&I portion (escrow/tax/ins still owed)
                savings += home.mortgagePI * 12 * ownership;
            }

            // Danebo payoff (not counted in expenses since it's a rental)
            // Century payoff (not counted in expenses since it's a rental)
            // Rentals already handled separately in rental income calculations

            return savings;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // Calculate portfolio with dynamic contributions (stops when each person retires)
        // Supports multiple contribution changes: array of {person, year, amount} objects
        function calculatePortfolioWithRetirements(years, returnRate, contribGrowth, mikeRetireYear, travisRetireYear, mikeContribStart, travisContribStart, changes = []) {
            let value = baseData.currentPortfolio;
            let mikeContrib = mikeContribStart;
            let travisContrib = travisContribStart;
            const projections = [];

            // Sort changes by year for proper application
            const sortedChanges = [...changes].sort((a, b) => a.year - b.year);

            projections.push({
                year: 0,
                calendarYear: baseData.currentYear,
                mikeAge: baseData.mikeAge,
                travisAge: baseData.travisAge,
                value: value,
                mikeRetired: false,
                travisRetired: false
            });

            // Get property sale info
            const r = getRentalInputValues();
            const ownership = baseData.rentalOwnership;
            const home = baseData.primaryResidence;

            for (let i = 1; i <= years; i++) {
                const calYear = baseData.currentYear + i;
                const mikeRetired = calYear > mikeRetireYear;
                const travisRetired = calYear > travisRetireYear;

                // Apply any contribution changes for this year (additive - adds to current amount)
                sortedChanges.forEach(change => {
                    if (change.year === calYear) {
                        if (change.person === 'mike') {
                            mikeContrib += change.amount;
                        } else if (change.person === 'travis') {
                            travisContrib += change.amount;
                        }
                    }
                });

                // Only count contributions from people still working
                let yearContrib = 0;
                if (!mikeRetired) yearContrib += mikeContrib;
                if (!travisRetired) yearContrib += travisContrib;

                // Add property sale proceeds if selling this year AND user wants to invest
                let saleProceeds = 0;
                if (r.homeSell && r.homeSellYear === calYear && r.homeInvestProceeds) {
                    // Use user-specified invest amount
                    saleProceeds += r.homeInvestAmount;
                }
                if (r.daneboSell && r.daneboSellYear === calYear && r.daneboInvestProceeds) {
                    // Use user-specified invest amount
                    saleProceeds += r.daneboInvestAmount;
                }
                if (r.centurySell && r.centurySellYear === calYear && r.centuryInvestProceeds) {
                    // Use user-specified invest amount
                    saleProceeds += r.centuryInvestAmount;
                }

                const growth = (value + yearContrib / 2) * returnRate;
                value = value + yearContrib + growth + saleProceeds;

                projections.push({
                    year: i,
                    calendarYear: calYear,
                    mikeAge: baseData.mikeAge + i,
                    travisAge: baseData.travisAge + i,
                    value: value,
                    mikeRetired: mikeRetired,
                    travisRetired: travisRetired,
                    contribution: yearContrib,
                    mikeContrib: mikeRetired ? 0 : mikeContrib,
                    travisContrib: travisRetired ? 0 : travisContrib
                });

                // Grow contributions for next year (after changes have been applied)
                if (!mikeRetired) mikeContrib *= (1 + contribGrowth);
                if (!travisRetired) travisContrib *= (1 + contribGrowth);
            }
            return projections;
        }

        // Calculate PERS pension
        // OPSRP normal retirement: age 65, or age 58 with 30 years of service
        // Early retirement: age 55 minimum, with actuarial reduction
        // If you leave PERS employment before 55, you can still collect at 55+ with reduced benefit
        //
        // Parameters:
        //   travisRetireAge: age when Travis stops working (leaves PERS employment)
        //   salaryGrowthRate: annual salary growth rate
        //   currentAge: Travis's current age at this point in the projection (for deferred collection)
        function calculatePERSPension(travisRetireAge, salaryGrowthRate, currentAge = null) {
            const normalRetireAge = 65;
            const earlyFullRetireAge = 58; // if 30+ years service
            const earliestCollectionAge = 55;

            // Years of service = time worked at PERS employer (stops when you leave, regardless of collection age)
            const yearsWorked = travisRetireAge - baseData.travisAge;
            const lastWorkYear = baseData.currentYear + yearsWorked;
            const yearsOfService = lastWorkYear - baseData.persStartYear;

            // Final Average Salary based on when you STOP working
            const fas = baseData.currentSalary * Math.pow(1 + salaryGrowthRate, yearsWorked);

            // Base pension before any reduction (based on years worked, not collection age)
            const basePension = baseData.persMultiplier * yearsOfService * fas;

            // Determine when pension collection begins
            // If you retire before 55, collection is deferred to 55
            const collectionAge = Math.max(travisRetireAge, earliestCollectionAge);

            // If currentAge is provided, check if we've reached collection age yet
            if (currentAge !== null && currentAge < collectionAge) {
                return {
                    yearsOfService,
                    fas,
                    basePension,
                    earlyRetireFactor: 0,
                    reductionNote: `Deferred to age ${collectionAge}`,
                    annualPension: 0,
                    collectionAge,
                    collecting: false
                };
            }

            // Calculate early retirement reduction factor based on COLLECTION age (not retirement age)
            let earlyRetireFactor = 1.0;
            let reductionNote = "Full benefit";

            if (collectionAge >= normalRetireAge) {
                earlyRetireFactor = 1.0;
                reductionNote = "Full benefit (age 65+)";
            } else if (collectionAge >= earlyFullRetireAge && yearsOfService >= 30) {
                earlyRetireFactor = 1.0;
                reductionNote = "Full benefit (58 + 30yrs)";
            } else {
                // Actuarial reduction based on OPSRP AEF tables
                // These factors are based on collection age, not when you stopped working
                const aefFactors = {
                    65: 1.00,
                    64: 0.90,
                    63: 0.81,
                    62: 0.73,
                    61: 0.66,
                    60: 0.60,
                    59: 0.55,
                    58: 0.50,
                    57: 0.46,
                    56: 0.42,
                    55: 0.39
                };

                const yearsEarly = normalRetireAge - collectionAge;
                earlyRetireFactor = aefFactors[collectionAge] || (1 - (yearsEarly * 0.08));
                const reductionPct = Math.round((1 - earlyRetireFactor) * 100);

                if (travisRetireAge < earliestCollectionAge) {
                    reductionNote = `-${reductionPct}% (collecting at ${collectionAge})`;
                } else {
                    reductionNote = `-${reductionPct}% (${yearsEarly} yrs early)`;
                }
            }

            const annualPension = basePension * earlyRetireFactor;

            return {
                yearsOfService,
                fas,
                basePension,
                earlyRetireFactor,
                reductionNote,
                annualPension,
                collectionAge,
                collecting: true
            };
        }

        // Calculate Social Security (reduced if taken early)
        function calculateSS(fullBenefit, claimAge) {
            if (claimAge >= 67) return fullBenefit * 12;
            if (claimAge >= 62) {
                // Roughly 6.67% reduction per year before 67
                const reduction = (67 - claimAge) * 0.0667;
                return fullBenefit * 12 * (1 - reduction);
            }
            return 0; // Can't claim before 62
        }

        function getInputValues() {
            return {
                mikeRetireAge: parseInt(document.getElementById('mikeRetireAge').value) || 62,
                travisRetireAge: parseInt(document.getElementById('travisRetireAge').value) || 62,
                mikeSalary: parseFloat(document.getElementById('mikeSalary').value) || 0,
                travisSalary: parseFloat(document.getElementById('travisSalary').value) || 0,
                mikeContrib: parseFloat(document.getElementById('mikeContrib').value) || 0,
                travisContrib: parseFloat(document.getElementById('travisContrib').value) || 0,
                // Multiple contribution changes (up to 5)
                contributionChanges: contributionChanges,
                returnRate: (parseFloat(document.getElementById('returnRate').value) || 0) / 100,
                inflationRate: (parseFloat(document.getElementById('inflationRate').value) || 0) / 100,
                withdrawalRate: (parseFloat(document.getElementById('withdrawalRate').value) || 0) / 100,
                federalTaxRate: (parseFloat(document.getElementById('federalTaxRate').value) || 0) / 100,
                oregonTaxRate: (parseFloat(document.getElementById('oregonTaxRate').value) || 0) / 100,
                expenseReduction: (parseFloat(document.getElementById('expenseReduction').value) || 0) / 100,
                contribIncrease: (parseFloat(document.getElementById('contribIncrease').value) || 0) / 100,
                salaryGrowth: (parseFloat(document.getElementById('salaryGrowth').value) || 0) / 100,
                healthcareCost: parseFloat(document.getElementById('healthcareCost').value) || 0,
                oneTimeExpenses: parseFloat(document.getElementById('oneTimeExpenses').value) || 0,
                mikeSs: parseFloat(document.getElementById('mikeSs').value) || 0,
                travisSs: parseFloat(document.getElementById('travisSs').value) || 0
            };
        }

        function calculateScenarios() {
            const v = getInputValues();
            const mikeRetireYear = baseData.currentYear + (v.mikeRetireAge - baseData.mikeAge);
            const travisRetireYear = baseData.currentYear + (v.travisRetireAge - baseData.travisAge);

            // Project portfolio for 35 years
            // Build step changes object
            const projections = calculatePortfolioWithRetirements(35, v.returnRate, v.contribIncrease, mikeRetireYear, travisRetireYear, v.mikeContrib, v.travisContrib, v.contributionChanges);

            // Calculate phases
            const phases = [];
            const baseRetirementExpenses = baseData.annualExpenses * (1 - v.expenseReduction);

            // Decompose base expenses into categories for breakdown display
            const baseMortgagePI = baseData.primaryResidence.mortgagePI * 12;
            const baseTaxInsurance = baseData.primaryResidence.propertyTax + baseData.primaryResidence.insurance;
            const baseLivingExpenses = baseData.annualExpenses - baseMortgagePI - baseTaxInsurance;
            const retiredLivingExpenses = baseLivingExpenses * (1 - v.expenseReduction);

            // Calculate home mortgage payoff year for expense breakdown
            const homeExtraPrincipalForPayoff = parseFloat(document.getElementById('homeExtraPrincipal').value) || 0;
            const homePayoffYear = calculateMortgagePayoff(
                baseData.primaryResidence.mortgageBalance,
                baseData.primaryResidence.mortgagePI,
                baseData.primaryResidence.mortgageRate,
                homeExtraPrincipalForPayoff,
                baseData.currentYear
            );

            // Determine key milestones
            const persCollectionAge = Math.max(v.travisRetireAge, 55);
            const persCollectionYear = baseData.currentYear + (persCollectionAge - baseData.travisAge);

            const milestones = [
                { year: mikeRetireYear, label: `Mike retires (${v.mikeRetireAge})` },
                { year: travisRetireYear, label: `Travis retires (${v.travisRetireAge})` },
                // Add PERS collection milestone if deferred (retiring before 55)
                ...(v.travisRetireAge < 55 ? [{ year: persCollectionYear, label: `PERS starts (Travis 55)` }] : []),
                { year: baseData.currentYear + (67 - baseData.mikeAge), label: 'Mike SS (67)' },
                { year: baseData.currentYear + (67 - baseData.travisAge), label: 'Travis SS (67)' },
                { year: baseData.currentYear + (65 - baseData.travisAge), label: 'Medicare (Travis 65)' }
            ].sort((a, b) => a.year - b.year);

            // Remove duplicates and past dates
            const uniqueMilestones = [];
            const seenYears = new Set();
            milestones.forEach(m => {
                if (m.year > baseData.currentYear && !seenYears.has(m.year)) {
                    seenYears.add(m.year);
                    uniqueMilestones.push(m);
                }
            });

            // Build phases based on milestones
            const phasePoints = [baseData.currentYear, ...uniqueMilestones.map(m => m.year)].slice(0, 6);

            phasePoints.forEach((year, idx) => {
                if (idx === 0) return; // Skip current year as start

                const yearsFromNow = year - baseData.currentYear;
                const proj = projections.find(p => p.calendarYear === year) || projections[projections.length - 1];
                const mikeAge = baseData.mikeAge + yearsFromNow;
                const travisAge = baseData.travisAge + yearsFromNow;

                // Calculate income at this point
                // Use >= so that retirement income kicks in during the retirement year
                const mikeRetired = year >= mikeRetireYear;
                const travisRetired = year >= travisRetireYear;
                const bothRetired = mikeRetired && travisRetired;

                // PERS pension (only if Travis has retired AND reached collection age)
                let pension = 0;
                let pensionReduction = '';
                if (travisRetired) {
                    // Pass current travisAge to check if pension collection has started
                    const persCalc = calculatePERSPension(v.travisRetireAge, v.salaryGrowth, travisAge);
                    pension = persCalc.annualPension;
                    if (persCalc.earlyRetireFactor < 1.0 || !persCalc.collecting) {
                        pensionReduction = persCalc.reductionNote;
                    }
                }

                // Portfolio income
                // If both retired: full withdrawal rate
                // If only one retired: partial withdrawal (they need income, but Travis may still have salary)
                let portfolioIncome = 0;
                if (bothRetired) {
                    portfolioIncome = proj.value * v.withdrawalRate;
                } else if (mikeRetired && !travisRetired) {
                    // Mike retired but Travis still working - Mike needs some income
                    // Estimate: Mike's share of expenses minus any pension he'd get (he has none)
                    // Simplified: ~40% of full withdrawal (Mike's portion of household)
                    portfolioIncome = proj.value * v.withdrawalRate * 0.4;
                } else if (travisRetired && !mikeRetired) {
                    // Travis retired but Mike still working
                    // Travis has PERS pension, so less portfolio needed
                    // But still needs some for expenses beyond pension
                    const gap = Math.max(0, (baseRetirementExpenses * 0.6) - pension);
                    portfolioIncome = Math.min(gap, proj.value * v.withdrawalRate * 0.3);
                }

                // Social Security (calculated before tax)
                let ssGross = 0;
                if (mikeAge >= 67) ssGross += v.mikeSs * 12;
                if (travisAge >= 67) ssGross += v.travisSs * 12;

                // Rental Income - calculated before tax
                const rentalInputs = getRentalInputValues();
                const rentalCalc = calculateRentalIncomeForYear(year, rentalInputs);
                let rentalGross = rentalCalc.totalNetIncome; // "net" of expenses, but pre-income-tax
                let rentalSaleProceeds = rentalCalc.saleProceeds;

                // === TAX CALCULATIONS ===
                // Save pre-tax values for SS threshold check
                const pensionGross = pension;
                const portfolioGross = portfolioIncome;
                const combinedRate = v.federalTaxRate + v.oregonTaxRate;

                // Federal + Oregon tax on pension and portfolio withdrawals
                pension = pension * (1 - combinedRate);
                portfolioIncome = portfolioIncome * (1 - combinedRate);

                // Federal + Oregon tax on rental income (positive rental income is taxable)
                let rentalIncome = rentalGross > 0 ? rentalGross * (1 - combinedRate) : rentalGross;

                // Federal tax on Social Security: ~85% taxable above $44K combined income
                // Use PRE-TAX gross income for threshold comparison
                let ssIncome = ssGross;
                const grossIncomeForSSTest = pensionGross + portfolioGross + ssGross + Math.max(0, rentalGross);
                if (ssGross > 0 && grossIncomeForSSTest > 44000) {
                    // 85% of SS is federally taxable (Oregon does NOT tax SS)
                    ssIncome = ssGross - (ssGross * 0.85 * v.federalTaxRate);
                }

                // === WORKING INCOME (salary for anyone still employed) ===
                let workingIncome = 0;
                if (!mikeRetired) {
                    const mikeSalaryGrown = v.mikeSalary * Math.pow(1 + v.salaryGrowth, yearsFromNow);
                    workingIncome += mikeSalaryGrown * (1 - combinedRate);
                }
                if (!travisRetired) {
                    const travisSalaryGrown = v.travisSalary * Math.pow(1 + v.salaryGrowth, yearsFromNow);
                    workingIncome += travisSalaryGrown * (1 - combinedRate);
                }

                // === EXPENSE BREAKDOWN ===
                const inflationFactor = Math.pow(1 + v.inflationRate, yearsFromNow);

                // Mortgage P&I: fixed nominal (not inflation-adjusted), drops to $0 at payoff
                const mortgageExpense = (year < homePayoffYear) ? baseMortgagePI : 0;

                // Property tax & insurance: grows with inflation
                const taxInsExpense = baseTaxInsurance * inflationFactor;

                // Living expenses: retirement-reduced, inflation-adjusted
                const livingExpense = retiredLivingExpenses * inflationFactor;

                // Healthcare: per-person pre-Medicare (65)
                let healthcareExpense = 0;
                if (mikeRetired && mikeAge < 65) healthcareExpense += v.healthcareCost;
                if (travisRetired && travisAge < 65) healthcareExpense += v.healthcareCost;

                // One-time expenses in first phase of full retirement
                let oneTimeExpense = 0;
                const prevPhaseYear = phasePoints[idx - 1];
                const prevBothRetired = (prevPhaseYear > mikeRetireYear) && (prevPhaseYear > travisRetireYear);
                if (bothRetired && !prevBothRetired) {
                    oneTimeExpense = v.oneTimeExpenses / 5;
                }

                let expenses = mortgageExpense + taxInsExpense + livingExpense + healthcareExpense + oneTimeExpense;

                const totalIncome = pension + portfolioIncome + ssIncome + rentalIncome + workingIncome;
                const surplus = totalIncome - expenses;

                phases.push({
                    year,
                    yearsFromNow,
                    mikeAge,
                    travisAge,
                    label: uniqueMilestones.find(m => m.year === year)?.label || `Year ${year}`,
                    portfolio: proj.value,
                    pension,
                    pensionReduction,
                    portfolioIncome,
                    ssIncome,
                    rentalIncome,
                    rentalSaleProceeds,
                    workingIncome,
                    totalIncome,
                    expenses,
                    surplus,
                    status: surplus >= 0 ? 'yes' : (surplus >= -expenses * 0.2 ? 'maybe' : 'no'),
                    expenseBreakdown: {
                        mortgage: mortgageExpense,
                        taxInsurance: taxInsExpense,
                        living: livingExpense,
                        healthcare: healthcareExpense,
                        oneTime: oneTimeExpense
                    }
                });
            });

            return { phases, projections, mikeRetireYear, travisRetireYear };
        }

        function renderScenarios(phases) {
            const tbody = document.getElementById('scenariosBody');
            tbody.innerHTML = phases.map(p => `
                <tr class="${p.label.includes('Travis retires') ? 'highlight-row' : ''}">
                    <td>
                        ${p.label}<br>
                        <span class="age-display">Mike ${p.mikeAge} / Travis ${p.travisAge}</span>
                    </td>
                    <td>${p.yearsFromNow} yrs</td>
                    <td>${formatCurrency(p.portfolio)}</td>
                    <td style="font-size: 0.7rem;">
                        ${p.workingIncome > 0 ? `<span style="color:#22c55e">Salary: ${formatCurrency(p.workingIncome)}</span><br>` : ''}
                        ${p.pension > 0 ? `PERS: ${formatCurrency(p.pension)}${p.pensionReduction ? `<br><span style="color:#f87171;font-size:0.6rem">${p.pensionReduction}</span>` : ''}<br>` : ''}
                        ${p.portfolioIncome > 0 ? `Port: ${formatCurrency(p.portfolioIncome)}<br>` : ''}
                        ${p.ssIncome > 0 ? `SS: ${formatCurrency(p.ssIncome)}<br>` : ''}
                        ${p.rentalIncome !== undefined ? `<span style="color:#fb923c">Rental: ${formatCurrency(p.rentalIncome)}</span>` : ''}
                        ${p.rentalSaleProceeds > 0 ? `<br><span style="color:#fbbf24;font-size:0.6rem">+Sale: ${formatCurrency(p.rentalSaleProceeds)}</span>` : ''}
                    </td>
                    <td>
                        ${p.totalIncome > 0 || p.rentalIncome !== 0 ? `
                            <span class="success-badge ${p.status}">
                                ${p.surplus >= 0 ? '+' : ''}${formatCurrency(p.surplus)}
                            </span>
                        ` : '<span style="color:var(--text-secondary)">‚Äî</span>'}
                    </td>
                </tr>
            `).join('');
        }

        function renderChart(projections, mikeRetireYear, travisRetireYear) {
            const ctx = document.getElementById('projectionChart').getContext('2d');
            if (chart) chart.destroy();

            const v = getInputValues();

            // Calculate target portfolio (amount needed to sustain retirement via withdrawal)
            // This is what you'd need if you had NO pension or SS - portfolio only
            const retirementExpenses = baseData.annualExpenses * (1 - v.expenseReduction);
            const targetPortfolio = retirementExpenses / v.withdrawalRate;

            // Find retirement year indices
            const mikeRetireIdx = projections.findIndex(p => p.calendarYear === mikeRetireYear);
            const travisRetireIdx = projections.findIndex(p => p.calendarYear === travisRetireYear);
            const laterRetireYear = Math.max(mikeRetireYear, travisRetireYear);

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: projections.map(p => p.calendarYear),
                    datasets: [{
                        label: 'Portfolio Value',
                        data: projections.map(p => p.value),
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: projections.map((p, i) =>
                            (i === mikeRetireIdx || i === travisRetireIdx) ? 6 : 0
                        ),
                        pointBackgroundColor: projections.map((p, i) =>
                            i === mikeRetireIdx ? '#60a5fa' :
                            i === travisRetireIdx ? '#4ade80' : '#4facfe'
                        ),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 46, 0.95)',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    const p = projections[context[0].dataIndex];
                                    return `Year ${p.calendarYear}`;
                                },
                                label: function(context) {
                                    const p = projections[context.dataIndex];
                                    return [
                                        `Mike: Age ${p.mikeAge}${p.mikeRetired ? ' (retired)' : ''}`,
                                        `Travis: Age ${p.travisAge}${p.travisRetired ? ' (retired)' : ''}`,
                                        `Portfolio: ${formatCurrency(p.value)}`,
                                        p.contribution !== undefined ? `Contributing: ${formatCurrency(p.contribution)}/yr` : ''
                                    ].filter(Boolean);
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                mikeRetireLine: {
                                    type: 'line',
                                    xMin: mikeRetireYear,
                                    xMax: mikeRetireYear,
                                    borderColor: '#60a5fa',
                                    borderWidth: 2,
                                    borderDash: [6, 4],
                                    label: {
                                        display: true,
                                        content: 'Mike',
                                        position: 'start',
                                        backgroundColor: '#60a5fa',
                                        color: '#fff',
                                        font: { size: 10 }
                                    }
                                },
                                travisRetireLine: {
                                    type: 'line',
                                    xMin: travisRetireYear,
                                    xMax: travisRetireYear,
                                    borderColor: '#4ade80',
                                    borderWidth: 2,
                                    borderDash: [6, 4],
                                    label: {
                                        display: true,
                                        content: 'Travis',
                                        position: 'start',
                                        backgroundColor: '#4ade80',
                                        color: '#fff',
                                        font: { size: 10 }
                                    }
                                },
                                targetLine: {
                                    type: 'line',
                                    yMin: targetPortfolio,
                                    yMax: targetPortfolio,
                                    borderColor: '#fbbf24',
                                    borderWidth: 2,
                                    borderDash: [8, 4],
                                    label: {
                                        display: true,
                                        content: `Target: ${formatCurrency(targetPortfolio)} (at ${(v.withdrawalRate*100).toFixed(1)}% withdrawal)`,
                                        position: 'end',
                                        backgroundColor: 'rgba(251, 191, 36, 0.9)',
                                        color: '#000',
                                        font: { size: 10 }
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: {
                                color: '#666',
                                maxTicksLimit: 10,
                                callback: function(value, index) {
                                    const p = projections[index];
                                    if (p.calendarYear === mikeRetireYear) return `${p.calendarYear}\n(M:${p.mikeAge})`;
                                    if (p.calendarYear === travisRetireYear) return `${p.calendarYear}\n(T:${p.travisAge})`;
                                    return index % 5 === 0 ? p.calendarYear : '';
                                }
                            }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: {
                                color: '#666',
                                callback: value => '$' + (value / 1000000).toFixed(1) + 'M'
                            }
                        }
                    }
                }
            });
        }

        // Global state for phase selection
        let currentPhases = [];
        let selectedPhaseIdx = -1; // -1 = auto-select full retirement

        function getActivePhaseIndex(phases) {
            if (selectedPhaseIdx >= 0 && selectedPhaseIdx < phases.length) {
                return selectedPhaseIdx;
            }
            // Auto-select: find first phase where both are retired (pension + portfolio)
            const fullRetireIdx = phases.findIndex(p => p.pension > 0 && p.portfolioIncome > 0);
            return fullRetireIdx >= 0 ? fullRetireIdx : phases.length - 1;
        }

        function selectPhase(idx) {
            selectedPhaseIdx = idx;
            renderPhaseTabs(currentPhases);
            renderIncomeExpenseBars(currentPhases);
        }

        function renderPhaseTabs(phases) {
            const container = document.getElementById('phaseTabs');
            if (!container || phases.length === 0) return;

            const activeIdx = getActivePhaseIndex(phases);

            container.innerHTML = phases.map((p, i) =>
                `<button class="phase-tab${i === activeIdx ? ' active' : ''}" onclick="selectPhase(${i})">${p.label}</button>`
            ).join('');
        }

        function renderIncomeBar(phases) {
            currentPhases = phases;
            selectedPhaseIdx = -1; // Reset to auto on each full update
            renderPhaseTabs(phases);
            renderIncomeExpenseBars(phases);
        }

        function renderIncomeExpenseBars(phases) {
            const activeIdx = getActivePhaseIndex(phases);
            const phase = phases[activeIdx];

            if (!phase) return;

            // Update subtitle
            const subtitle = document.getElementById('incomeBreakdownSubtitle');
            if (subtitle) {
                subtitle.textContent = `(Mike ${phase.mikeAge} / Travis ${phase.travisAge})`;
            }

            // === INCOME BAR ===
            const rentalIncome = Math.max(0, phase.rentalIncome || 0);
            const salaryIncome = phase.workingIncome || 0;
            const totalIncome = phase.pension + phase.portfolioIncome + phase.ssIncome + rentalIncome + salaryIncome;

            const incomeBar = document.getElementById('incomeBar');
            const incomeLegend = document.getElementById('incomeLegend');
            const incomeTotal = document.getElementById('incomeTotal');

            if (totalIncome <= 0) {
                if (incomeTotal) incomeTotal.textContent = '$0';
                incomeBar.innerHTML = '<div style="width:100%;background:var(--bg-tertiary);color:var(--text-muted);font-size:0.8rem;">No income sources active yet</div>';
                incomeLegend.innerHTML = '';
            } else {
                if (incomeTotal) incomeTotal.textContent = formatCurrency(totalIncome);

                const salaryPct = (salaryIncome / totalIncome) * 100;
                const pensionPct = (phase.pension / totalIncome) * 100;
                const portfolioPct = (phase.portfolioIncome / totalIncome) * 100;
                const ssPct = (phase.ssIncome / totalIncome) * 100;
                const rentalPct = (rentalIncome / totalIncome) * 100;

                incomeBar.innerHTML = `
                    ${salaryPct > 0 ? `<div class="bar-salary" style="width:${salaryPct}%">${salaryPct > 10 ? 'Salary' : ''}</div>` : ''}
                    ${pensionPct > 0 ? `<div class="bar-pension" style="width:${pensionPct}%">${pensionPct > 10 ? 'PERS' : ''}</div>` : ''}
                    ${portfolioPct > 0 ? `<div class="bar-portfolio" style="width:${portfolioPct}%">${portfolioPct > 10 ? 'Portfolio' : ''}</div>` : ''}
                    ${ssPct > 0 ? `<div class="bar-ss" style="width:${ssPct}%">${ssPct > 10 ? 'SS' : ''}</div>` : ''}
                    ${rentalPct > 0 ? `<div class="bar-rental" style="width:${rentalPct}%">${rentalPct > 10 ? 'Rental' : ''}</div>` : ''}
                `;

                const v = getInputValues();
                // Build income legend ‚Äî only show non-zero items
                let incomeLegendItems = [];
                if (salaryIncome > 0) incomeLegendItems.push(`<div class="legend-item"><div class="legend-dot" style="background:#22c55e"></div>Salary: ${formatCurrency(salaryIncome)} (${salaryPct.toFixed(0)}%)</div>`);
                if (phase.pension > 0) incomeLegendItems.push(`<div class="legend-item"><div class="legend-dot" style="background:#fbbf24"></div>PERS: ${formatCurrency(phase.pension)} (${pensionPct.toFixed(0)}%)</div>`);
                if (phase.portfolioIncome > 0) incomeLegendItems.push(`<div class="legend-item"><div class="legend-dot" style="background:#4facfe"></div>Portfolio (${(v.withdrawalRate * 100).toFixed(1)}%): ${formatCurrency(phase.portfolioIncome)} (${portfolioPct.toFixed(0)}%)</div>`);
                if (phase.ssIncome > 0) incomeLegendItems.push(`<div class="legend-item"><div class="legend-dot" style="background:#a78bfa"></div>SS: ${formatCurrency(phase.ssIncome)} (${ssPct.toFixed(0)}%)</div>`);
                if (rentalIncome > 0) incomeLegendItems.push(`<div class="legend-item"><div class="legend-dot" style="background:#fb923c"></div>Rental: ${formatCurrency(rentalIncome)} (${rentalPct.toFixed(0)}%)</div>`);
                incomeLegendItems.push(`<div class="legend-item" style="margin-left:auto;"><strong>Total: ${formatCurrency(totalIncome)}/yr</strong></div>`);
                incomeLegend.innerHTML = incomeLegendItems.join('');
            }

            // === EXPENSE BAR ===
            const eb = phase.expenseBreakdown;
            const totalExpenses = phase.expenses;
            const expenseBar = document.getElementById('expenseBar');
            const expenseLegend = document.getElementById('expenseLegend');
            const expenseTotal = document.getElementById('expenseTotal');

            if (expenseTotal) expenseTotal.textContent = formatCurrency(totalExpenses);

            if (!eb || totalExpenses <= 0) {
                expenseBar.innerHTML = '<div style="width:100%;background:var(--bg-tertiary);color:var(--text-muted);font-size:0.8rem;">No expenses</div>';
                expenseLegend.innerHTML = '';
            } else {
                const mortgagePct = (eb.mortgage / totalExpenses) * 100;
                const taxInsPct = (eb.taxInsurance / totalExpenses) * 100;
                const livingPct = (eb.living / totalExpenses) * 100;
                const healthcarePct = (eb.healthcare / totalExpenses) * 100;
                const oneTimePct = (eb.oneTime / totalExpenses) * 100;

                expenseBar.innerHTML = `
                    ${mortgagePct > 0 ? `<div class="bar-mortgage" style="width:${mortgagePct}%">${mortgagePct > 8 ? 'Mortgage' : ''}</div>` : ''}
                    ${taxInsPct > 0 ? `<div class="bar-taxins" style="width:${taxInsPct}%">${taxInsPct > 8 ? 'Tax+Ins' : ''}</div>` : ''}
                    ${livingPct > 0 ? `<div class="bar-living" style="width:${livingPct}%">${livingPct > 10 ? 'Living' : ''}</div>` : ''}
                    ${healthcarePct > 0 ? `<div class="bar-healthcare" style="width:${healthcarePct}%">${healthcarePct > 8 ? 'Healthcare' : ''}</div>` : ''}
                    ${oneTimePct > 0 ? `<div class="bar-onetime" style="width:${oneTimePct}%">${oneTimePct > 8 ? 'One-time' : ''}</div>` : ''}
                `;

                // Build legend ‚Äî only show non-zero categories
                let legendItems = [];
                if (eb.mortgage > 0) legendItems.push(`<div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div>Mortgage P&I: ${formatCurrency(eb.mortgage)} (${mortgagePct.toFixed(0)}%)</div>`);
                if (eb.taxInsurance > 0) legendItems.push(`<div class="legend-item"><div class="legend-dot" style="background:#f97316"></div>Tax & Ins: ${formatCurrency(eb.taxInsurance)} (${taxInsPct.toFixed(0)}%)</div>`);
                legendItems.push(`<div class="legend-item"><div class="legend-dot" style="background:#8b5cf6"></div>Living: ${formatCurrency(eb.living)} (${livingPct.toFixed(0)}%)</div>`);
                if (eb.healthcare > 0) legendItems.push(`<div class="legend-item"><div class="legend-dot" style="background:#ec4899"></div>Healthcare: ${formatCurrency(eb.healthcare)} (${healthcarePct.toFixed(0)}%)</div>`);
                if (eb.oneTime > 0) legendItems.push(`<div class="legend-item"><div class="legend-dot" style="background:#6366f1"></div>One-time: ${formatCurrency(eb.oneTime)} (${oneTimePct.toFixed(0)}%)</div>`);
                legendItems.push(`<div class="legend-item" style="margin-left:auto;"><strong>Total: ${formatCurrency(totalExpenses)}/yr</strong></div>`);

                expenseLegend.innerHTML = legendItems.join('');
            }

            // === PROPORTIONAL BAR SCALING ===
            const max = Math.max(totalIncome, totalExpenses);
            const incomeBarWrapper = document.getElementById('incomeBarWrapper');
            const expenseBarWrapper = document.getElementById('expenseBarWrapper');
            if (incomeBarWrapper && max > 0) incomeBarWrapper.style.width = ((totalIncome / max) * 100) + '%';
            if (expenseBarWrapper && max > 0) expenseBarWrapper.style.width = ((totalExpenses / max) * 100) + '%';

            // === SURPLUS / DEFICIT INDICATOR ===
            const surplusEl = document.getElementById('surplusIndicator');
            if (surplusEl) {
                const surplus = phase.surplus;
                if (totalIncome <= 0 && totalExpenses <= 0) {
                    surplusEl.innerHTML = '';
                    surplusEl.className = 'surplus-indicator';
                } else if (surplus >= 0) {
                    surplusEl.innerHTML = `+${formatCurrency(surplus)}/yr surplus`;
                    surplusEl.className = 'surplus-indicator surplus';
                } else {
                    surplusEl.innerHTML = `${formatCurrency(surplus)}/yr shortfall`;
                    surplusEl.className = 'surplus-indicator deficit';
                }
            }
        }

        function updateDisplays() {
            const v = getInputValues();

            // Retirement timing helper text
            const mikeYearsEl = document.getElementById('mikeYearsToRetire');
            const travisYearsEl = document.getElementById('travisYearsToRetire');
            const mikeYearEl = document.getElementById('mikeRetireYear');
            const travisYearEl = document.getElementById('travisRetireYear');

            if (mikeYearsEl) mikeYearsEl.textContent = v.mikeRetireAge - baseData.mikeAge;
            if (travisYearsEl) travisYearsEl.textContent = v.travisRetireAge - baseData.travisAge;
            if (mikeYearEl) mikeYearEl.textContent = baseData.currentYear + (v.mikeRetireAge - baseData.mikeAge);
            if (travisYearEl) travisYearEl.textContent = baseData.currentYear + (v.travisRetireAge - baseData.travisAge);

            // Contribution displays (sync with person cards at bottom)
            const mikeContribEl = document.getElementById('mikeContribDisplay');
            const travisContribEl = document.getElementById('travisContribDisplay');
            if (mikeContribEl) mikeContribEl.textContent = formatCurrency(v.mikeContrib);
            if (travisContribEl) travisContribEl.textContent = formatCurrency(v.travisContrib);
        }

        function updateSummaryCards(phases) {
            const v = getInputValues();

            // Find Travis retirement phase for pension preview
            // Don't pass currentAge here - we want to show what pension will be when collecting
            const pers = calculatePERSPension(v.travisRetireAge, v.salaryGrowth);
            document.getElementById('pensionPreview').textContent = formatCurrency(pers.annualPension) + '/yr';

            // Show when collection starts
            const collectionNote = v.travisRetireAge < 55
                ? `${pers.yearsOfService.toFixed(1)} yrs service, collect at 55`
                : `${pers.yearsOfService.toFixed(1)} yrs service at age ${v.travisRetireAge}`;
            document.getElementById('pensionSubtext').textContent = collectionNote;

            // Show early retirement reduction if applicable
            const reductionEl = document.getElementById('pensionReduction');
            if (pers.earlyRetireFactor < 1.0) {
                reductionEl.innerHTML = `‚ö†Ô∏è ${pers.reductionNote}<br>Full would be ${formatCurrency(pers.basePension)}`;
                reductionEl.style.display = 'block';
                reductionEl.style.color = '#f87171';
            } else {
                reductionEl.innerHTML = `‚úì ${pers.reductionNote}`;
                reductionEl.style.color = '#4ade80';
            }

            // Find full retirement phase
            const fullRetirePhase = phases.find(p => p.pension > 0 && p.portfolioIncome > 0);
            if (fullRetirePhase) {
                document.getElementById('totalIncomePreview').textContent = formatCurrency(fullRetirePhase.totalIncome) + '/yr';
                const gap = fullRetirePhase.surplus;
                document.getElementById('gapValue').textContent = (gap >= 0 ? '+' : '') + formatCurrency(gap);
                document.getElementById('gapValue').className = 'card-value ' + (gap >= 0 ? 'green' : 'red');
                document.getElementById('gapSubtext').textContent = gap >= 0 ? 'Annual surplus' : 'Annual shortfall';

                // Update retirement status banner
                updateStatusBanner(fullRetirePhase, v);
            }
        }

        function updateStatusBanner(phase, inputs) {
            const banner = document.getElementById('statusBanner');
            const icon = document.getElementById('statusIcon');
            const title = document.getElementById('statusTitle');
            const detail = document.getElementById('statusDetail');

            const surplus = phase.surplus;
            const expenses = phase.expenses;
            const surplusPercent = (surplus / expenses) * 100;

            // Remove existing classes
            banner.classList.remove('green', 'yellow', 'red');

            if (surplusPercent >= 10) {
                // Green: 10%+ surplus - comfortable buffer
                banner.classList.add('green');
                icon.textContent = '‚úì';
                title.textContent = 'On Track for Retirement';
                detail.textContent = `Income exceeds expenses by ${formatCurrency(surplus)}/year (+${surplusPercent.toFixed(0)}% buffer) when both retired`;
            } else if (surplusPercent >= -5) {
                // Yellow: -5% to +10% - close but may need adjustments
                banner.classList.add('yellow');
                icon.textContent = '‚ö†';
                if (surplus >= 0) {
                    title.textContent = 'Close - Consider Adjustments';
                    detail.textContent = `Income just covers expenses (+${formatCurrency(surplus)}/year). A small buffer is wise for unexpected costs.`;
                } else {
                    title.textContent = 'Slightly Short - Review Options';
                    detail.textContent = `Income is ${formatCurrency(Math.abs(surplus))}/year below expenses. Consider working longer, saving more, or reducing expenses.`;
                }
            } else {
                // Red: More than 5% shortfall - needs attention
                banner.classList.add('red');
                icon.textContent = '‚úó';
                title.textContent = 'Needs Attention';
                detail.textContent = `Income is ${formatCurrency(Math.abs(surplus))}/year below expenses (${Math.abs(surplusPercent).toFixed(0)}% gap). Adjust retirement age, savings, or expenses.`;
            }
        }

        function update() {
            updateDisplays();
            updateRentalDisplays();
            updateHomeDisplays();
            const { phases, projections, mikeRetireYear, travisRetireYear } = calculateScenarios();
            renderScenarios(phases);
            renderChart(projections, mikeRetireYear, travisRetireYear);
            renderIncomeBar(phases);
            updateSummaryCards(phases);
        }

        // Debounced update for smoother mobile experience
        let updateTimer = null;
        function debouncedUpdate() {
            if (updateTimer) clearTimeout(updateTimer);
            updateTimer = setTimeout(update, 150);
        }

        // Event listeners ‚Äî use multiple event types for mobile compatibility
        // iOS Safari sometimes doesn't fire 'input' on number fields until blur
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('input', debouncedUpdate);
            input.addEventListener('change', update);  // Fires on blur / stepper tap
            input.addEventListener('blur', update);     // Catches iOS keyboard dismiss
        });

        // Checkbox and select listeners (inline handlers already exist,
        // but this ensures any dynamically added ones are caught)
        document.querySelectorAll('input[type="checkbox"]').forEach(input => {
            input.addEventListener('change', update);
        });
        document.querySelectorAll('select').forEach(input => {
            input.addEventListener('change', update);
        });

        // Initial render
        loadTheme();
        loadSectionStates();
        renderChangesTable();
        update();
    </script>
</body>
</html>
